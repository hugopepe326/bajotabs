<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BassTAB ‚Äî Electric Bass Tablature Extractor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;0,700;1,300&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0c0c0f; --bg2:#13131a; --surface:#1a1a24; --surface2:#22222f;
  --border:#2a2a3a; --border2:#38384f;
  --accent:#7c6af7; --accent-l:#a89bff; --accent-dim:rgba(124,106,247,.13);
  --gold:#f0c060; --gold-dim:rgba(240,192,96,.12);
  --green:#4ecb8d; --green-dim:rgba(78,203,141,.10);
  --teal:#38c9c9; --teal-dim:rgba(56,201,201,.10);
  --red:#f06060;
  --fg:#eeeaf8; --fg2:#aaa8c0; --fg3:#6b6888;
  --r:10px; --r-lg:16px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--fg);font-family:'JetBrains Mono',monospace;
  min-height:100vh;display:flex;flex-direction:column;align-items:center;overflow-x:hidden}
body::before{content:'';position:fixed;top:-20vh;left:50%;transform:translateX(-50%);
  width:100vw;height:70vh;
  background:radial-gradient(ellipse 60% 50% at 50% 0%,rgba(124,106,247,.06) 0%,transparent 100%);
  pointer-events:none;z-index:0}
.wrap{width:100%;max-width:760px;padding:0 24px 100px;position:relative;z-index:1}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.hdr{padding:56px 0 44px}
.hdr-top{display:flex;align-items:baseline;gap:16px;flex-wrap:wrap;margin-bottom:12px}
.logo{font-family:'Syne',sans-serif;font-size:clamp(52px,11vw,90px);font-weight:800;
  letter-spacing:-.03em;line-height:1;color:var(--fg)}
.logo-badge{font-family:'Syne',sans-serif;font-size:clamp(15px,3vw,22px);font-weight:600;
  color:var(--accent-l);padding:4px 12px;background:var(--accent-dim);
  border:1px solid rgba(124,106,247,.25);border-radius:6px;letter-spacing:.04em}
.tagline{font-size:12px;color:var(--fg3);letter-spacing:.14em;text-transform:uppercase;font-weight:300}
.hdr-rule{width:100%;height:1px;background:linear-gradient(90deg,var(--accent) 0%,transparent 70%);
  margin-top:16px;opacity:.35}

/* ‚îÄ‚îÄ Sections ‚îÄ‚îÄ */
.sec{margin-bottom:20px}
.sec-lbl{font-family:'Syne',sans-serif;font-size:10px;font-weight:700;letter-spacing:.22em;
  text-transform:uppercase;color:var(--fg3);margin-bottom:14px;
  display:flex;align-items:center;gap:12px}
.sec-lbl::after{content:'';flex:1;height:1px;background:var(--border)}

/* ‚îÄ‚îÄ Drop zone ‚îÄ‚îÄ */
.drop{border:1.5px dashed var(--border2);border-radius:var(--r-lg);padding:48px 32px 40px;
  text-align:center;cursor:pointer;position:relative;overflow:hidden;background:var(--bg2);
  transition:border-color .25s,background .25s,transform .2s}
.drop:hover,.drop.over{border-color:var(--accent);background:var(--accent-dim);transform:translateY(-2px)}
.drop input{position:absolute;inset:0;opacity:0;cursor:pointer}
.drop-ico{font-size:42px;display:block;margin-bottom:16px;
  filter:drop-shadow(0 0 16px rgba(124,106,247,.35))}
.drop-title{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;margin-bottom:8px}
.drop-hint{font-size:12px;color:var(--fg3);letter-spacing:.05em;line-height:1.8}
.drop-hint b{color:var(--accent-l);font-weight:500}
.file-badge{display:none;margin-top:16px;padding:9px 16px;background:var(--accent-dim);
  border:1px solid var(--accent);border-radius:6px;font-size:12px;color:var(--accent-l)}
.file-badge.on{display:inline-block}

/* Upload progress */
.up-wrap{display:none;margin-top:16px}
.up-wrap.on{display:block}
.up-row{display:flex;justify-content:space-between;margin-bottom:7px}
.up-lbl{font-size:11px;letter-spacing:.12em;color:var(--fg3);text-transform:uppercase}
.up-pct{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:var(--accent-l)}
.track{width:100%;height:4px;background:var(--border);border-radius:999px;overflow:hidden}
.fill{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent-l));width:0%;transition:width .35s ease}

/* Meta inputs */
.meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.fld{display:flex;flex-direction:column;gap:8px}
.fld-lbl{font-size:11px;letter-spacing:.14em;text-transform:uppercase;color:var(--fg3)}
.fld-inp,.fld-sel,.fld-ta{background:var(--surface);border:1.5px solid var(--border);
  border-radius:var(--r);color:var(--fg);font-family:'JetBrains Mono',monospace;
  font-size:14px;padding:13px 16px;outline:none;
  transition:border-color .2s,background .2s;width:100%}
.fld-inp:focus,.fld-sel:focus,.fld-ta:focus{border-color:var(--accent);background:var(--surface2)}
.fld-inp::placeholder,.fld-ta::placeholder{color:var(--fg3)}
.fld-ta{resize:vertical;min-height:120px;line-height:1.7;font-size:13px}
.fld-sel{cursor:pointer;-webkit-appearance:none;appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b6888' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 14px center;
  background-color:var(--surface);padding-right:38px}
.fld-sel option{background:#1a1a24}

/* Lyrics section */
.lyrics-card{background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r-lg);padding:24px;margin-bottom:14px;position:relative;overflow:hidden}
.lyrics-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,var(--teal) 0%,transparent 60%)}
.lyrics-hint{font-size:12px;color:var(--fg3);line-height:1.7;margin-bottom:14px}
.lyrics-hint b{color:var(--teal);font-weight:500}
.lyrics-char-count{font-size:11px;color:var(--fg3);margin-top:8px;text-align:right}

/* Lyrics search row */
.lyrics-search-row{display:flex;gap:10px;align-items:flex-end;margin-bottom:14px}
.lyrics-search-row .fld{flex:1}
.btn-search-lyr{padding:13px 18px;background:var(--teal-dim);border:1.5px solid var(--teal);
  border-radius:var(--r);color:var(--teal);font-family:'Syne',sans-serif;font-size:13px;
  font-weight:700;letter-spacing:.07em;cursor:pointer;white-space:nowrap;
  transition:background .2s,color .2s,transform .2s;display:flex;align-items:center;gap:8px;flex-shrink:0}
.btn-search-lyr:hover:not(:disabled){background:var(--teal);color:#061818;transform:translateY(-1px)}
.btn-search-lyr:disabled{opacity:.4;cursor:not-allowed;transform:none}
.lyrics-status{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:8px;
  font-size:12px;margin-bottom:12px;display:none}
.lyrics-status.on{display:flex}
.lyrics-status.searching{background:var(--teal-dim);border:1px solid rgba(56,201,201,.25);color:var(--teal)}
.lyrics-status.found{background:var(--green-dim);border:1px solid rgba(78,203,141,.25);color:var(--green)}
.lyrics-status.error{background:rgba(240,96,96,.08);border:1px solid rgba(240,96,96,.25);color:var(--red)}
.lyrics-spinner{width:14px;height:14px;border:2px solid currentColor;border-top-color:transparent;
  border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}
.lyrics-edit-note{font-size:11px;color:var(--fg3);margin-top:6px;font-style:italic}

/* Buttons */
.btn-main{width:100%;padding:18px;background:linear-gradient(135deg,var(--accent) 0%,#5a48d0 100%);
  color:white;border:none;border-radius:var(--r);font-family:'Syne',sans-serif;
  font-size:17px;font-weight:700;letter-spacing:.09em;cursor:pointer;
  transition:opacity .2s,transform .2s,box-shadow .2s;
  box-shadow:0 4px 28px rgba(124,106,247,.28)}
.btn-main:hover:not(:disabled){opacity:.9;transform:translateY(-2px);box-shadow:0 8px 36px rgba(124,106,247,.38)}
.btn-main:disabled{opacity:.3;cursor:not-allowed;transform:none;box-shadow:none}
.btn-outline{padding:14px 22px;background:transparent;border:1.5px solid var(--accent);
  border-radius:var(--r);color:var(--accent-l);font-family:'Syne',sans-serif;
  font-size:14px;font-weight:700;letter-spacing:.08em;cursor:pointer;
  transition:background .2s,color .2s,transform .2s;
  display:inline-flex;align-items:center;gap:8px;white-space:nowrap}
.btn-outline:hover{background:var(--accent);color:white;transform:translateY(-1px)}
.btn-new{width:100%;padding:15px;background:transparent;
  border:1.5px dashed var(--border2);border-radius:var(--r);
  color:var(--fg3);font-family:'Syne',sans-serif;font-size:15px;font-weight:600;
  letter-spacing:.07em;cursor:pointer;transition:all .2s;margin-top:12px;
  display:flex;align-items:center;justify-content:center;gap:10px}
.btn-new:hover{border-color:var(--accent-l);color:var(--accent-l);background:var(--accent-dim)}

/* Download buttons row */
.dl-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
.btn-dl{padding:14px 20px;border:none;border-radius:var(--r);font-family:'Syne',sans-serif;
  font-size:14px;font-weight:700;letter-spacing:.07em;cursor:pointer;text-decoration:none;
  display:inline-flex;align-items:center;justify-content:center;gap:8px;
  transition:opacity .2s,transform .2s;white-space:nowrap}
.btn-dl-std{background:var(--green);color:#0a1a10}
.btn-dl-lyr{background:var(--teal);color:#061818}
.btn-dl:hover{opacity:.9;transform:translateY(-1px)}

/* Analysis progress */
.ana-wrap{display:none;background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r-lg);padding:30px;margin-top:20px}
.ana-wrap.on{display:block}
.ana-title{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:22px}
.steps{display:flex;flex-direction:column;gap:13px}
.step{display:flex;align-items:center;gap:16px;opacity:.3;transition:opacity .3s}
.step.active{opacity:1}.step.done{opacity:.65}
.step-num{width:30px;height:30px;border-radius:50%;background:var(--border);
  border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;color:var(--fg3);flex-shrink:0;
  transition:background .3s,border-color .3s,color .3s}
.step.active .step-num{background:var(--accent-dim);border-color:var(--accent);color:var(--accent-l);animation:pd 1.4s ease-in-out infinite}
.step.done .step-num{background:var(--green-dim);border-color:var(--green);color:var(--green)}
@keyframes pd{0%,100%{box-shadow:0 0 0 0 rgba(124,106,247,.4)}50%{box-shadow:0 0 0 7px rgba(124,106,247,0)}}
.step-txt{font-size:13px;color:var(--fg2)}.step.active .step-txt{color:var(--fg)}
.big-track{width:100%;height:6px;background:var(--border);border-radius:999px;overflow:hidden;margin-top:26px}
.big-fill{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent-l));width:0%;transition:width .5s ease}

/* Results */
.results{display:none}.results.on{display:block}

/* Key card */
.key-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);
  padding:28px;margin-bottom:14px;position:relative;overflow:hidden}
.key-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,var(--gold) 0%,transparent 60%)}
.key-top{display:flex;align-items:flex-start;justify-content:space-between;gap:20px;flex-wrap:wrap;margin-bottom:24px}
.key-main{display:flex;flex-direction:column;gap:4px}
.key-lbl{font-size:11px;letter-spacing:.18em;color:var(--fg3);text-transform:uppercase}
.key-val{font-family:'Syne',sans-serif;font-size:54px;font-weight:800;color:var(--gold);line-height:1;letter-spacing:-.02em}
.key-mode{font-size:14px;color:var(--fg2);margin-top:4px}
.key-stats{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
.key-stat{font-size:12px;color:var(--fg3);text-align:right}
.key-stat strong{color:var(--fg2);font-weight:400}
.sub-ttl{font-size:10px;letter-spacing:.18em;color:var(--fg3);text-transform:uppercase;margin-bottom:12px}

/* Scale & notes used pills */
.pills{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:22px}
.pill{padding:6px 13px;background:var(--bg);border:1px solid var(--border2);border-radius:6px;font-size:13px;color:var(--fg2)}
.pill.root{background:var(--gold-dim);border-color:var(--gold);color:var(--gold);font-weight:600}
.pill.used{background:var(--accent-dim);border-color:rgba(124,106,247,.35);color:var(--accent-l)}
.pill.used.root{background:var(--gold-dim);border-color:var(--gold);color:var(--gold)}

/* Chord chips */
.chords{display:flex;gap:10px;flex-wrap:wrap}
.chord-chip{display:flex;flex-direction:column;align-items:center;gap:4px;
  padding:12px 14px;background:var(--bg);border:1px solid var(--border2);
  border-radius:var(--r);min-width:54px;transition:border-color .2s,transform .2s;cursor:default}
.chord-chip:hover{border-color:var(--accent);transform:translateY(-2px)}
.chord-chip.tonic{background:var(--gold-dim);border-color:rgba(240,192,96,.3)}
.chord-roman{font-size:10px;color:var(--fg3);letter-spacing:.06em}
.chord-name{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;color:var(--fg)}
.chord-chip.tonic .chord-name{color:var(--gold)}
.chord-type{font-size:9px;color:var(--fg3)}

/* Transpose card */
.xp-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:28px;margin-bottom:14px}
.xp-controls{display:grid;grid-template-columns:1fr 1fr auto;gap:14px;align-items:end}
.xp-display{display:flex;align-items:center;justify-content:center;gap:10px;padding:20px 0;margin-top:16px;border-top:1px solid var(--border)}
.xp-key-wrap{display:flex;flex-direction:column;align-items:center;gap:5px}
.xp-key-lbl{font-size:10px;letter-spacing:.14em;color:var(--fg3);text-transform:uppercase}
.xp-key-from{font-family:'Syne',sans-serif;font-size:32px;font-weight:800;color:var(--fg2)}
.xp-key-to{font-family:'Syne',sans-serif;font-size:32px;font-weight:800;color:var(--accent-l)}
.xp-mid{display:flex;flex-direction:column;align-items:center;gap:6px;padding:0 16px}
.xp-arrow{font-size:20px;color:var(--fg3)}
.xp-semi-badge{font-size:11px;color:var(--fg3);padding:4px 10px;background:var(--bg);border-radius:6px;border:1px solid var(--border)}

/* Notes-used card */
.notes-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);
  padding:26px 28px;margin-bottom:14px;position:relative;overflow:hidden}
.notes-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,var(--accent-l) 0%,transparent 60%)}
.notes-freq-bars{display:flex;gap:6px;align-items:flex-end;height:56px;margin-top:12px}
.note-bar-wrap{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1}
.note-bar{width:100%;border-radius:4px 4px 0 0;background:var(--accent-dim);border:1px solid rgba(124,106,247,.2);transition:background .3s;min-height:4px}
.note-bar.highlighted{background:linear-gradient(180deg,var(--accent-l),var(--accent));border-color:var(--accent)}
.note-bar-name{font-size:10px;color:var(--fg3);letter-spacing:.04em;font-weight:500}
.note-bar-wrap.root-note .note-bar{background:linear-gradient(180deg,#f8d580,var(--gold));border-color:var(--gold)}
.note-bar-wrap.root-note .note-bar-name{color:var(--gold);font-weight:700}

/* Download section */
.dl-card{background:var(--green-dim);border:1px solid var(--green);border-radius:var(--r-lg);
  padding:24px 28px}
.dl-status{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.dl-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:blink 2s ease infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}
.dl-status-txt{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:var(--green)}
.dl-meta{font-size:11px;color:var(--fg3);margin-bottom:16px}

/* Error */
.err{display:none;background:rgba(240,96,96,.08);border:1px solid var(--red);
  border-radius:var(--r);padding:16px 20px;font-size:13px;color:var(--red);
  line-height:1.6;margin-top:16px}
.err.on{display:block}

/* Info tiles */
.tiles{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:36px}
.tile{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:18px 16px}
.tile-lbl{font-size:10px;letter-spacing:.16em;color:var(--fg3);text-transform:uppercase;margin-bottom:8px}
.tile-val{font-family:'Syne',sans-serif;font-size:15px;font-weight:600;color:var(--fg);line-height:1.3}
.tile-sub{font-size:10px;color:var(--fg3);margin-top:3px}

/* Responsive */
@media(max-width:600px){
  .meta-grid{grid-template-columns:1fr}
  .xp-controls{grid-template-columns:1fr 1fr}
  .xp-controls .btn-outline{grid-column:1/-1;width:100%;justify-content:center}
  .tiles{grid-template-columns:repeat(2,1fr)}
  .dl-row{grid-template-columns:1fr}
  .key-top{flex-direction:column}
  .key-stats{align-items:flex-start}
}
@media(max-width:420px){.wrap{padding:0 16px 60px}.drop{padding:36px 20px 30px}.logo{font-size:46px}}
</style>
</head>
<body>
<div class="wrap">

<!-- Header -->
<header class="hdr">
  <div class="hdr-top"><span class="logo">BassTAB</span><span class="logo-badge">Extractor</span></div>
  <p class="tagline">MP3 ‚Üí Electric bass tablature ‚Üí PDF ¬∑ Client-side ¬∑ Standard tuning E A D G</p>
  <div class="hdr-rule"></div>
</header>

<!-- 01 Upload -->
<div class="sec">
  <div class="sec-lbl">01 ¬∑ Upload</div>
  <div class="drop" id="drop">
    <input type="file" id="fileIn" accept=".mp3,audio/mpeg">
    <span class="drop-ico">üé∏</span>
    <div class="drop-title">Drop your MP3 here</div>
    <div class="drop-hint">Click to browse or drag &amp; drop ¬∑ <b>Best results</b> with isolated bass, stems or DI recordings ¬∑ Max 50 MB</div>
    <div class="file-badge" id="fileBadge"></div>
  </div>
  <div class="up-wrap" id="upWrap">
    <div class="up-row"><span class="up-lbl">Reading file</span><span class="up-pct" id="upPct">0%</span></div>
    <div class="track"><div class="fill" id="upFill"></div></div>
  </div>
</div>

<!-- 02 Song Info -->
<div class="sec">
  <div class="sec-lbl">02 ¬∑ Song Info</div>
  <div class="meta-grid">
    <div class="fld">
      <label class="fld-lbl" for="songName">Song title</label>
      <input class="fld-inp" type="text" id="songName" placeholder="Enter song title‚Ä¶">
    </div>
    <div class="fld">
      <label class="fld-lbl" for="artistName">Artist</label>
      <input class="fld-inp" type="text" id="artistName" placeholder="Enter artist name‚Ä¶">
    </div>
  </div>
</div>

<!-- 03 Lyrics (optional) -->
<div class="sec">
  <div class="sec-lbl">03 ¬∑ Lyrics <span style="color:var(--fg3);font-size:9px;letter-spacing:.1em">(optional)</span></div>
  <div class="lyrics-card">
    <p class="lyrics-hint">
      Search for lyrics automatically using AI, or paste them manually below.<br>
      Fill in <b>Song title</b> and <b>Artist</b> first, then hit <b>Search Lyrics</b>.
    </p>

    <!-- Search row -->
    <div class="lyrics-search-row">
      <div class="fld">
        <label class="fld-lbl">Quick search</label>
        <input class="fld-inp" type="text" id="lyricsQuery"
          placeholder="Song title ‚Äî Artist (auto-filled from above)">
      </div>
      <button class="btn-search-lyr" id="btnSearchLyr" onclick="searchLyrics()" disabled>
        <span id="searchIcon">üîç</span> Search lyrics
      </button>
    </div>

    <!-- Status banner -->
    <div class="lyrics-status" id="lyricsStatus">
      <div class="lyrics-spinner" id="lyricsSpinner" style="display:none"></div>
      <span id="lyricsStatusTxt"></span>
    </div>

    <!-- Editable textarea -->
    <div class="fld">
      <textarea class="fld-ta" id="lyricsText"
        placeholder="Lyrics will appear here after searching, or paste them manually.&#10;&#10;Each line = one lyric phrase. Blank lines separate sections.&#10;&#10;Example:&#10;[Verse 1]&#10;First line of lyrics...&#10;Second line...&#10;&#10;[Chorus]&#10;Chorus here..."
        rows="8" oninput="updateLyricsCount()"></textarea>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
        <div class="lyrics-edit-note" id="lyricsEditNote" style="display:none">
          ‚úé Auto-fetched ‚Äî review and edit before generating PDF
        </div>
        <div style="flex:1"></div>
        <div class="lyrics-char-count" id="lyricsCount">0 lines</div>
      </div>
    </div>
  </div>
</div>

<!-- Extract -->
<div class="sec">
  <button class="btn-main" id="procBtn" disabled onclick="startExtraction()">Analyze &amp; Extract Bass Tab</button>
  <div class="err" id="errBox"></div>
</div>

<!-- Analysis progress -->
<div class="ana-wrap" id="anaWrap">
  <div class="ana-title">Analyzing audio‚Ä¶</div>
  <div class="steps">
    <div class="step" id="s1"><div class="step-num">1</div><span class="step-txt">Decoding MP3 and reading audio data</span></div>
    <div class="step" id="s2"><div class="step-num">2</div><span class="step-txt">Applying low-pass filter ‚Äî bass isolation</span></div>
    <div class="step" id="s3"><div class="step-num">3</div><span class="step-txt">YIN pitch detection ‚Äî frame-by-frame analysis</span></div>
    <div class="step" id="s4"><div class="step-num">4</div><span class="step-txt">Detecting key, scale, used notes &amp; chord progression</span></div>
    <div class="step" id="s5"><div class="step-num">5</div><span class="step-txt">Generating PDF tablature</span></div>
  </div>
  <div class="big-track"><div class="big-fill" id="bigFill"></div></div>
</div>

<!-- Results -->
<div class="results" id="results">
  <div class="sec-lbl" style="margin-top:6px">Analysis</div>

  <!-- Key card -->
  <div class="key-card">
    <div class="key-top">
      <div class="key-main">
        <span class="key-lbl">Detected Key</span>
        <div class="key-val" id="keyVal">‚Äî</div>
        <div class="key-mode" id="keyMd">‚Äî</div>
      </div>
      <div class="key-stats">
        <div class="key-stat">Notes: <strong id="noteCnt">‚Äî</strong></div>
        <div class="key-stat">Duration: <strong id="songDur">‚Äî</strong></div>
        <div class="key-stat">Confidence: <strong id="keyCnf">‚Äî</strong></div>
      </div>
    </div>
    <div class="sub-ttl">Scale notes</div>
    <div class="pills" id="scalePills"></div>
    <div class="sub-ttl">Diatonic chord progression</div>
    <div class="chords" id="chordsEl"></div>
  </div>

  <!-- Notes used -->
  <div class="notes-card">
    <div class="sub-ttl" style="margin-bottom:0">Notes used in the song</div>
    <div class="notes-freq-bars" id="notesBars"></div>
    <div class="pills" id="usedNotesPills" style="margin-top:14px;margin-bottom:0"></div>
  </div>

  <!-- 04 Transpose -->
  <div class="sec-lbl" style="margin-top:20px">04 ¬∑ Transpose</div>
  <div class="xp-card">
    <div class="xp-controls">
      <div class="fld">
        <label class="fld-lbl" for="xpDir">Semitones / direction</label>
        <select class="fld-sel" id="xpDir">
          <option value="0">No transposition (0 st)</option>
          <option value="1">+1 semitone</option>
          <option value="2">+2 semitones  (1 tone)</option>
          <option value="3">+3 semitones</option>
          <option value="4">+4 semitones  (2 tones)</option>
          <option value="5">+5 semitones</option>
          <option value="6">+6 semitones  (tritone)</option>
          <option value="7">+7 semitones  (5th ‚Üë)</option>
          <option value="-1">‚àí1 semitone</option>
          <option value="-2">‚àí2 semitones  (1 tone)</option>
          <option value="-3">‚àí3 semitones</option>
          <option value="-4">‚àí4 semitones  (2 tones)</option>
          <option value="-5">‚àí5 semitones</option>
          <option value="-6">‚àí6 semitones</option>
          <option value="-7">‚àí7 semitones  (4th ‚Üì)</option>
        </select>
      </div>
      <div class="fld">
        <label class="fld-lbl" for="tgtKey">Target key</label>
        <select class="fld-sel" id="tgtKey"><option value="">‚Äî auto ‚Äî</option></select>
      </div>
      <button class="btn-outline" onclick="updateXpDisplay()">Update</button>
    </div>

    <!-- Transposed notes used (updates dynamically) -->
    <div style="margin-top:18px;padding-top:16px;border-top:1px solid var(--border)">
      <div class="sub-ttl" style="margin-bottom:10px">Transposed notes</div>
      <div class="pills" id="xpNotesPills"></div>
    </div>

    <div class="xp-display">
      <div class="xp-key-wrap">
        <span class="xp-key-lbl">Original</span>
        <span class="xp-key-from" id="xpFrom">‚Äî</span>
      </div>
      <div class="xp-mid">
        <span class="xp-arrow">‚Üí</span>
        <span class="xp-semi-badge" id="xpSemi">0 semitones</span>
      </div>
      <div class="xp-key-wrap">
        <span class="xp-key-lbl">Transposed to</span>
        <span class="xp-key-to" id="xpTo">‚Äî</span>
      </div>
    </div>
  </div>

  <!-- Download -->
  <div class="dl-card">
    <div class="dl-status"><div class="dl-dot"></div><span class="dl-status-txt">Tablature ready</span></div>
    <div class="dl-meta" id="dlMeta">‚Äî</div>
    <div class="dl-row">
      <a class="btn-dl btn-dl-std" id="dlStd" href="#" download>‚Üì Download TAB only</a>
      <a class="btn-dl btn-dl-lyr" id="dlLyr" href="#" download style="display:none">‚Üì Download TAB + Lyrics</a>
    </div>
    <div id="dlLyrNote" style="display:none;margin-top:10px;font-size:11px;color:var(--teal)">
      ‚úì Lyrics version available ‚Äî notes are aligned to lyric phrases by time position.
    </div>
  </div>

  <!-- New song button -->
  <button class="btn-new" onclick="resetForNewSong()">
    <span style="font-size:18px">Ôºã</span> Analyze another song
  </button>

</div><!-- /results -->

<!-- Info tiles -->
<div class="tiles">
  <div class="tile"><div class="tile-lbl">Tuning</div><div class="tile-val">E ¬∑ A ¬∑ D ¬∑ G</div><div class="tile-sub">Standard 4-string</div></div>
  <div class="tile"><div class="tile-lbl">Algorithm</div><div class="tile-val">YIN</div><div class="tile-sub">Time-domain pitch detection</div></div>
  <div class="tile"><div class="tile-lbl">Output</div><div class="tile-val">A4 PDF</div><div class="tile-sub">Printable tablature</div></div>
  <div class="tile"><div class="tile-lbl">Processing</div><div class="tile-val">Client-side</div><div class="tile-sub">No server ¬∑ No data sent</div></div>
</div>

</div><!-- /wrap -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const NM   = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const STR  = [{name:"G",midi:43},{name:"D",midi:38},{name:"A",midi:33},{name:"E",midi:28}];
const KS_MAJ=[6.35,2.23,3.48,2.33,4.38,4.09,2.52,5.19,2.39,3.66,2.29,2.88];
const KS_MIN=[6.33,2.68,3.52,5.38,2.60,3.53,2.54,4.75,3.98,2.69,3.34,3.17];
const MAJ_INT=[0,2,4,5,7,9,11], MIN_INT=[0,2,3,5,7,8,10];
const MAJ_TYPES=["maj","min","min","maj","maj","min","dim"];
const MIN_TYPES=["min","dim","maj","min","min","maj","maj"];
const MAJ_ROM=["I","ii","iii","IV","V","vi","vii¬∞"];
const MIN_ROM=["i","ii¬∞","III","iv","v","VI","VII"];

let gNotes=[], gKeyRoot=0, gKeyMode='major', gAudioBuf=null, gSongDuration=0;

const $=id=>document.getElementById(id);
const tick=()=>new Promise(r=>setTimeout(r,40));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MUSIC HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const f2m  = f   => 69+12*Math.log2(f/440);
const m2nn = m   => NM[((Math.round(m)%12)+12)%12]+(Math.floor(m/12)-1);
const pc   = m   => ((Math.round(m)%12)+12)%12;
const trR  = (r,s)=> ((r+s)%12+12)%12;

function midiToTab(midi){
  let best=null,bf=999;
  for(const s of STR){const f=Math.round(midi)-s.midi;if(f>=0&&f<=24&&f<bf){bf=f;best={string:s.name,fret:f};}}
  return best;
}

function detectKey(notes){
  const h=new Float64Array(12); let tot=0;
  for(const n of notes){h[pc(n.midi)]+=n.duration;tot+=n.duration;}
  if(!tot)return{root:0,mode:'major',confidence:0};
  for(let i=0;i<12;i++)h[i]/=tot;
  let best=-Infinity,root=0,mode='major';
  for(let r=0;r<12;r++){
    let sm=0,sn=0;
    for(let i=0;i<12;i++){sm+=h[(i+r)%12]*KS_MAJ[i];sn+=h[(i+r)%12]*KS_MIN[i];}
    if(sm>best){best=sm;root=r;mode='major';}
    if(sn>best){best=sn;root=r;mode='minor';}
  }
  return{root,mode,confidence:Math.min(99,Math.round(best*180))};
}

function getChords(root,mode){
  const ints=mode==='major'?MAJ_INT:MIN_INT;
  const types=mode==='major'?MAJ_TYPES:MIN_TYPES;
  const romans=mode==='major'?MAJ_ROM:MIN_ROM;
  return ints.map((iv,d)=>({root:(root+iv)%12,name:NM[(root+iv)%12],type:types[d],roman:romans[d],tonic:d===0}));
}

// Get used pitch classes with frequency weight
function getUsedNotes(notes){
  const hist=new Float64Array(12);
  for(const n of notes) hist[pc(n.midi)]+=n.duration;
  return hist;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// YIN PITCH DETECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function yinPitch(buf,sr,thr=0.11){
  const W=buf.length,half=Math.floor(W/2);
  const d=new Float32Array(half);
  for(let t=1;t<half;t++){let s=0;for(let j=0;j<half;j++){const x=buf[j]-buf[j+t];s+=x*x;}d[t]=s;}
  const c=new Float32Array(half);c[0]=1;
  let run=0;
  for(let t=1;t<half;t++){run+=d[t];c[t]=run>0?d[t]*t/run:1;}
  const lo=Math.floor(sr/196),hi=Math.min(Math.floor(sr/41),half-2);
  let t=lo;
  while(t<hi){if(c[t]<thr){while(t+1<hi&&c[t+1]<c[t])t++;break;}t++;}
  if(t>=hi||c[t]>=thr)return null;
  let bt=t;
  if(t>0&&t<half-1){const s0=c[t-1],s1=c[t],s2=c[t+1],dn=2*(2*s1-s2-s0);if(Math.abs(dn)>1e-10)bt=t+(s2-s0)/dn;}
  return sr/bt;
}
function lpf(input,sr,cutoff){
  const a=1/(1+sr/(2*Math.PI*cutoff)),out=new Float32Array(input.length);
  out[0]=input[0];for(let i=1;i<input.length;i++)out[i]=out[i-1]+a*(input[i]-out[i-1]);
  return out;
}
async function extractNotes(buf,onPct){
  const ctx=new(window.AudioContext||window.webkitAudioContext)();
  const ab=await ctx.decodeAudioData(buf.slice(0));
  const nCh=ab.numberOfChannels,len=ab.length,sr=ab.sampleRate;
  const mono=new Float32Array(len);
  for(let c=0;c<nCh;c++){const ch=ab.getChannelData(c);for(let i=0;i<len;i++)mono[i]+=ch[i]/nCh;}
  ctx.close();
  const filt=lpf(mono,sr,280);
  const HOP=Math.floor(sr*.04),WIN=Math.floor(sr*.08);
  const tot=Math.floor((len-WIN)/HOP),ft=HOP/sr;
  const raw=[];let pm=null,ns=0,nd=0;
  for(let fi=0;fi<tot;fi++){
    if(fi%80===0)onPct(10+(fi/tot)*70);
    const frame=filt.slice(fi*HOP,fi*HOP+WIN);
    let rms=0;for(const s of frame)rms+=s*s;rms=Math.sqrt(rms/frame.length);
    const t=fi*ft;
    if(rms<0.002){if(pm!==null){if(nd>=.06)raw.push({time:ns,duration:nd,midi:pm});pm=null;}continue;}
    const freq=yinPitch(frame,sr,0.11);
    if(!freq){if(pm!==null){if(nd>=.06)raw.push({time:ns,duration:nd,midi:pm});pm=null;}continue;}
    const m=Math.round(f2m(freq));
    if(m<28||m>51){if(pm!==null){if(nd>=.06)raw.push({time:ns,duration:nd,midi:pm});pm=null;}continue;}
    if(m===pm){nd+=ft;}else{if(pm!==null&&nd>=.06)raw.push({time:ns,duration:nd,midi:pm});pm=m;ns=t;nd=ft;}
  }
  if(pm!==null&&nd>=.06)raw.push({time:ns,duration:nd,midi:pm});
  return raw.map(n=>{const tab=midiToTab(n.midi);return tab?{...n,noteName:m2nn(n.midi),string:tab.string,fret:tab.fret}:null;}).filter(Boolean);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LYRICS PARSING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseLyrics(text){
  // Returns array of {text, lineIndex} ‚Äî flat list of lyric lines
  if(!text||!text.trim())return[];
  return text.split('\n').map(l=>l.trim()).filter(l=>l.length>0);
}

// Assign a note index to each lyric line based on song timeline
// Each lyric line gets the notes that fall in its proportional time window
function alignLyricsToNotes(lines, notes, songDuration){
  if(!lines.length||!notes.length)return[];
  const segDur = songDuration / lines.length;
  return lines.map((text,i)=>{
    const tStart = i*segDur, tEnd = (i+1)*segDur;
    const segNotes = notes.filter(n=>n.time>=tStart&&n.time<tEnd);
    return{text, tStart, tEnd, notes:segNotes};
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF GENERATION ‚Äî TAB ONLY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function makePDF_TabOnly(notes,song,artist,keyRoot,keyMode,semi){
  const{jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',unit:'pt',format:'a4'});
  const PW=595.28,PH=841.89,ML=38,MR=38,CW=PW-ML-MR;
  const newRoot=trR(keyRoot,semi);
  const keyStr=NM[keyRoot]+' '+keyMode;
  const xpStr=semi!==0?`  ‚Üí  ${NM[newRoot]} ${keyMode}  (${semi>0?'+':''}${semi} st)`:'';
  const info=`Key: ${keyStr}${xpStr}`;

  // Staff geometry ‚Äî larger than previous version
  const TW=15,SSX=ML+TW+5,SSW=CW-TW-5;
  const SS=14,SH=SS*3,MPR=4,MW=SSW/MPR; // SS=14 (was 11)
  const FIRST_Y=90,ROW_STEP=SH+42;       // more breathing room
  const ROWS_PG=Math.floor((PH-FIRST_Y-28)/ROW_STEP);

  let bpm=100;
  if(notes.length>4){const sp=notes[notes.length-1].time-notes[0].time;bpm=Math.max(60,Math.min(160,Math.round(notes.length/sp*28)));}
  const MD=(60/bpm)*4,RD=MD*MPR;
  const maxT=notes.length>0?notes[notes.length-1].time+1:1;
  const totalRows=Math.ceil(maxT/RD);
  const SMAP={G:0,D:1,A:2,E:3};
  const SLABELS=['G','D','A','E'];

  function drawHdr(){
    doc.setDrawColor(210,205,230);doc.setLineWidth(0.4);doc.line(ML,20,PW-MR,20);
    const HY=44;
    doc.setFont('helvetica','normal');doc.setFontSize(9);doc.setTextColor(110,108,130);
    doc.text('SONG',ML,HY);
    const slw=doc.getTextWidth('SONG'),sls=ML+slw+5,sle=ML+215;
    if(song){doc.setFont('helvetica','italic');doc.setFontSize(9);doc.setTextColor(20,20,35);doc.text(song,sls+2,HY-1);doc.setFont('helvetica','normal');}
    doc.setDrawColor(60,58,90);doc.setLineWidth(0.5);doc.line(sls,HY+2,sle,HY+2);
    const ax=ML+250;
    doc.setFont('helvetica','normal');doc.setFontSize(9);doc.setTextColor(110,108,130);
    doc.text('ARTIST',ax,HY);
    const alw=doc.getTextWidth('ARTIST'),als=ax+alw+5,ale=PW-MR;
    if(artist){doc.setFont('helvetica','italic');doc.setFontSize(9);doc.setTextColor(20,20,35);doc.text(artist,als+2,HY-1);doc.setFont('helvetica','normal');}
    doc.line(als,HY+2,ale,HY+2);
    doc.setFont('helvetica','normal');doc.setFontSize(7.5);doc.setTextColor(110,95,185);
    doc.text(info,PW/2,HY+14,{align:'center'});
    doc.setDrawColor(200,196,220);doc.setLineWidth(0.35);doc.line(ML,HY+22,PW-MR,HY+22);
  }

  function drawStaff(ri,yTop){
    const mn=ri*MPR+1;
    doc.setFont('helvetica','italic');doc.setFontSize(7);doc.setTextColor(140,132,175);
    doc.text(String(mn),ML,yTop-4);
    doc.setFont('helvetica','bold');doc.setFontSize(7.5);doc.setTextColor(100,95,140);
    for(let si=0;si<4;si++)doc.text(SLABELS[si],ML+TW-2,yTop+si*SS+3.5,{align:'center'});
    doc.setDrawColor(50,48,75);doc.setLineWidth(0.4);
    for(let si=0;si<4;si++)doc.line(SSX,yTop+si*SS,SSX+SSW,yTop+si*SS);
    for(let bi=0;bi<=MPR;bi++){
      const bx=SSX+bi*MW;doc.setLineWidth(bi===0||bi===MPR?1.2:0.55);doc.setDrawColor(50,48,75);
      doc.line(bx,yTop,bx,yTop+SH);
    }
    doc.setFont('helvetica','bold');doc.setFontSize(7.5);doc.setTextColor(110,100,155);
    const tx=ML+TW/2;
    doc.text('T',tx,yTop+1.5,{align:'center'});
    doc.text('A',tx,yTop+SS+1.5,{align:'center'});
    doc.text('B',tx,yTop+SS*2+1.5,{align:'center'});
  }

  function drawNote(note,rStart,yTop,semi){
    const rel=note.time-rStart;if(rel<0||rel>=RD)return;
    const transM=note.midi+semi,tab=midiToTab(transM);if(!tab)return;
    const nx=SSX+(rel/RD)*SSW,si=SMAP[tab.string]??3,ny=yTop+si*SS;
    const fs=String(tab.fret),fw=fs.length>1?11:8;
    doc.setFillColor(255,255,255);doc.rect(nx-fw/2-1,ny-6.5,fw+2,9,'F');
    doc.setFont('helvetica','bold');doc.setFontSize(8.5);doc.setTextColor(0,0,0);
    doc.text(fs,nx,ny+2.2,{align:'center'});
  }

  let curPg=0;drawHdr();
  for(let ri=0;ri<totalRows;ri++){
    const pg=Math.floor(ri/ROWS_PG);
    if(pg>curPg){doc.addPage();curPg=pg;drawHdr();}
    const lr=ri%ROWS_PG,yTop=FIRST_Y+lr*ROW_STEP;
    drawStaff(ri,yTop);
    const rs=ri*RD,re=rs+RD;
    notes.filter(n=>n.time>=rs&&n.time<re).forEach(n=>drawNote(n,rs,yTop,semi));
  }
  const tp=doc.getNumberOfPages();
  for(let p=1;p<=tp;p++){
    doc.setPage(p);doc.setDrawColor(190,186,210);doc.setLineWidth(0.3);doc.line(ML,PH-22,PW-MR,PH-22);
    doc.setFont('helvetica','normal');doc.setFontSize(7);doc.setTextColor(160,155,185);
    doc.text(`Page ${p} / ${tp}`,PW/2,PH-13,{align:'center'});
  }
  return doc.output('blob');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF GENERATION ‚Äî TAB + LYRICS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function makePDF_WithLyrics(notes,song,artist,keyRoot,keyMode,semi,lyricsLines){
  const{jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',unit:'pt',format:'a4'});
  const PW=595.28,PH=841.89,ML=38,MR=38,CW=PW-ML-MR;
  const newRoot=trR(keyRoot,semi);
  const keyStr=NM[keyRoot]+' '+keyMode;
  const xpStr=semi!==0?`  ‚Üí  ${NM[newRoot]} ${keyMode}  (${semi>0?'+':''}${semi} st)`:'';
  const info=`Key: ${keyStr}${xpStr}`;

  // In lyrics mode: each lyric line gets its own mini staff block
  // Staff is wider / bigger for legibility
  const TW=15,SSX=ML+TW+5,SSW=CW-TW-5;
  const SS=13,SH=SS*3,MPR=4,MW=SSW/MPR;
  const LYRIC_H=16; // height of lyric text row above staff
  const BLOCK_H=SH+LYRIC_H+28; // total height per lyric block
  const FIRST_Y=82;
  const BLOCKS_PG=Math.floor((PH-FIRST_Y-28)/BLOCK_H);
  const SMAP={G:0,D:1,A:2,E:3};
  const SLABELS=['G','D','A','E'];

  // Align lyrics to notes
  const songDur=notes.length>0?notes[notes.length-1].time+1:1;
  const aligned=alignLyricsToNotes(lyricsLines,notes,songDur);

  let bpm=100;
  if(notes.length>4){const sp=notes[notes.length-1].time-notes[0].time;bpm=Math.max(60,Math.min(160,Math.round(notes.length/sp*28)));}
  const segDurPDF=songDur/aligned.length; // each segment's duration in song time

  function drawHdr(){
    doc.setDrawColor(210,205,230);doc.setLineWidth(0.4);doc.line(ML,18,PW-MR,18);
    const HY=40;
    doc.setFont('helvetica','normal');doc.setFontSize(9);doc.setTextColor(110,108,130);
    doc.text('SONG',ML,HY);
    const slw=doc.getTextWidth('SONG'),sls=ML+slw+5,sle=ML+215;
    if(song){doc.setFont('helvetica','italic');doc.setFontSize(9);doc.setTextColor(20,20,35);doc.text(song,sls+2,HY-1);doc.setFont('helvetica','normal');}
    doc.setDrawColor(60,58,90);doc.setLineWidth(0.5);doc.line(sls,HY+2,sle,HY+2);
    const ax=ML+250;
    doc.setFont('helvetica','normal');doc.setFontSize(9);doc.setTextColor(110,108,130);
    doc.text('ARTIST',ax,HY);
    const alw=doc.getTextWidth('ARTIST'),als=ax+alw+5,ale=PW-MR;
    if(artist){doc.setFont('helvetica','italic');doc.setFontSize(9);doc.setTextColor(20,20,35);doc.text(artist,als+2,HY-1);doc.setFont('helvetica','normal');}
    doc.line(als,HY+2,ale,HY+2);
    doc.setFont('helvetica','normal');doc.setFontSize(7.5);doc.setTextColor(110,95,185);
    doc.text(info,PW/2,HY+13,{align:'center'});
    doc.setDrawColor(200,196,220);doc.setLineWidth(0.35);doc.line(ML,HY+20,PW-MR,HY+20);
  }

  function drawLyricBlock(seg,blockIdx){
    const pg=Math.floor(blockIdx/BLOCKS_PG);
    if(pg>0&&blockIdx%BLOCKS_PG===0){doc.addPage();drawHdr();}
    const lb=blockIdx%BLOCKS_PG;
    const yLyric=FIRST_Y+lb*BLOCK_H;
    const yTop=yLyric+LYRIC_H+4;

    // Lyric text
    doc.setFont('helvetica','italic');doc.setFontSize(9.5);doc.setTextColor(40,38,70);
    // Truncate if too long
    let lyricText=seg.text;
    const maxW=SSW+TW;
    while(lyricText.length>4&&doc.getTextWidth(lyricText)>maxW-4) lyricText=lyricText.slice(0,-1)+'‚Ä¶';
    doc.text(lyricText,SSX,yLyric+10);

    // Light divider
    doc.setDrawColor(230,228,240);doc.setLineWidth(0.3);doc.line(SSX,yLyric+13,SSX+SSW,yLyric+13);

    // String labels
    doc.setFont('helvetica','bold');doc.setFontSize(7.5);doc.setTextColor(100,95,140);
    for(let si=0;si<4;si++)doc.text(SLABELS[si],ML+TW-2,yTop+si*SS+3.5,{align:'center'});

    // TAB label
    doc.setFont('helvetica','bold');doc.setFontSize(7.5);doc.setTextColor(110,100,155);
    const tx=ML+TW/2;
    doc.text('T',tx,yTop+1,{align:'center'});doc.text('A',tx,yTop+SS+1,{align:'center'});doc.text('B',tx,yTop+SS*2+1,{align:'center'});

    // Horizontal lines
    doc.setDrawColor(50,48,75);doc.setLineWidth(0.4);
    for(let si=0;si<4;si++)doc.line(SSX,yTop+si*SS,SSX+SSW,yTop+si*SS);

    // Bar lines (just start and end for lyric mode, cleaner look)
    doc.setLineWidth(1.0);doc.setDrawColor(50,48,75);
    doc.line(SSX,yTop,SSX,yTop+SH);
    doc.line(SSX+SSW,yTop,SSX+SSW,yTop+SH);
    // internal bars at quarters
    doc.setLineWidth(0.45);
    for(let bi=1;bi<MPR;bi++){const bx=SSX+bi*MW;doc.line(bx,yTop,bx,yTop+SH);}

    // Draw notes for this segment within the block width
    const segDur=seg.tEnd-seg.tStart;
    if(segDur<=0||seg.notes.length===0)return;
    for(const note of seg.notes){
      const rel=note.time-seg.tStart;
      if(rel<0||rel>=segDur)continue;
      const transM=note.midi+semi,tab=midiToTab(transM);if(!tab)continue;
      const nx=SSX+(rel/segDur)*SSW;
      const si=SMAP[tab.string]??3,ny=yTop+si*SS;
      const fs=String(tab.fret),fw=fs.length>1?10:8;
      doc.setFillColor(255,255,255);doc.rect(nx-fw/2-1,ny-6,fw+2,8.5,'F');
      doc.setFont('helvetica','bold');doc.setFontSize(8);doc.setTextColor(0,0,0);
      doc.text(fs,nx,ny+2,{align:'center'});
    }
  }

  // Render first page header
  drawHdr();

  // Render each lyric block
  aligned.forEach((seg,i)=>drawLyricBlock(seg,i));

  // Footers
  const tp=doc.getNumberOfPages();
  for(let p=1;p<=tp;p++){
    doc.setPage(p);doc.setDrawColor(190,186,210);doc.setLineWidth(0.3);doc.line(ML,PH-22,PW-MR,PH-22);
    doc.setFont('helvetica','normal');doc.setFontSize(7);doc.setTextColor(160,155,185);
    doc.text(`Page ${p} / ${tp}`,PW/2,PH-13,{align:'center'});
  }
  return doc.output('blob');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showErr(msg){const e=$('errBox');e.textContent='‚ö† '+msg;e.classList.add('on');}
function ss(id,st){const e=$(id);e.classList.remove('active','done');if(st)e.classList.add(st);}
function updateLyricsCount(){
  const lines=parseLyrics($('lyricsText').value);
  $('lyricsCount').textContent=`${lines.length} line${lines.length!==1?'s':''}`;
}

// ‚îÄ‚îÄ Sync lyricsQuery field from song/artist inputs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function syncLyricsQuery(){
  const s=$('songName').value.trim(), a=$('artistName').value.trim();
  if(s||a) $('lyricsQuery').value=[s,a].filter(Boolean).join(' ‚Äî ');
  else $('lyricsQuery').value='';
  $('btnSearchLyr').disabled=!(s||a);
}

// ‚îÄ‚îÄ Lyrics search via Anthropic API (web search enabled) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function searchLyrics(){
  const query = $('lyricsQuery').value.trim();
  if(!query) return;

  const btn=$('btnSearchLyr'), status=$('lyricsStatus'), statusTxt=$('lyricsStatusTxt');
  const spinner=$('lyricsSpinner'), icon=$('searchIcon');

  // UI: searching state
  btn.disabled=true; icon.textContent='‚è≥';
  status.className='lyrics-status on searching';
  spinner.style.display='block';
  statusTxt.textContent='Searching for lyrics‚Ä¶';

  const systemPrompt = `You are a lyrics retrieval assistant. When asked for song lyrics, search the web and return ONLY the complete song lyrics as plain text ‚Äî no commentary, no preamble, no markdown, no "Here are the lyrics:". Format: each sung line on its own line. Separate verses/choruses/bridges with a single blank line. Include section labels like [Verse 1], [Chorus] etc. If you cannot find the lyrics, respond with exactly: NOT_FOUND`;

  const userPrompt = `Find the complete lyrics for: ${query}`;

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1500,
        system: systemPrompt,
        tools: [{ type: 'web_search_20250305', name: 'web_search' }],
        messages: [{ role: 'user', content: userPrompt }]
      })
    });

    if(!resp.ok){
      const errData = await resp.json().catch(()=>({}));
      throw new Error(errData.error?.message || `API error ${resp.status}`);
    }

    const data = await resp.json();

    // Extract text from content blocks
    const textBlocks = data.content.filter(b=>b.type==='text').map(b=>b.text);
    const fullText = textBlocks.join('\n').trim();

    if(!fullText || fullText === 'NOT_FOUND' || fullText.startsWith('NOT_FOUND')) {
      status.className='lyrics-status on error';
      spinner.style.display='none';
      statusTxt.textContent='Lyrics not found. Try a different search or paste them manually.';
    } else {
      $('lyricsText').value = fullText;
      updateLyricsCount();
      status.className='lyrics-status on found';
      spinner.style.display='none';
      const lineCount = parseLyrics(fullText).length;
      statusTxt.textContent = `‚úì Found ${lineCount} lines ‚Äî review and edit below if needed.`;
      $('lyricsEditNote').style.display='block';
      // Rebuild downloads if analysis already done
      if(gNotes.length){ const s=parseInt($('xpDir').value)||0; buildDownloads(s); }
    }

  } catch(e) {
    status.className='lyrics-status on error';
    spinner.style.display='none';
    const msg = e.message||'Unknown error';
    if(msg.includes('401')||msg.includes('auth')||msg.toLowerCase().includes('api key')){
      statusTxt.textContent='API key missing or invalid. Try pasting lyrics manually.';
    } else if(msg.includes('network')||msg.includes('fetch')){
      statusTxt.textContent='Network error. Check connection or paste lyrics manually.';
    } else {
      statusTxt.textContent=`Search failed: ${msg.slice(0,80)}. Paste lyrics manually.`;
    }
  }

  btn.disabled=false; icon.textContent='üîç';
}

// Render note frequency bars
function renderNoteBars(hist,keyRoot){
  const el=$('notesBars');el.innerHTML='';
  const maxH=Math.max(...hist);if(maxH===0)return;
  for(let i=0;i<12;i++){
    if(hist[i]===0)continue;
    const pct=hist[i]/maxH;
    const wrap=document.createElement('div');wrap.className='note-bar-wrap';
    if(i===keyRoot)wrap.classList.add('root-note');
    const bar=document.createElement('div');
    bar.className='note-bar'+(hist[i]>maxH*.3?' highlighted':'');
    bar.style.height=Math.max(6,Math.round(pct*50))+'px';
    const lbl=document.createElement('div');lbl.className='note-bar-name';lbl.textContent=NM[i];
    wrap.appendChild(bar);wrap.appendChild(lbl);el.appendChild(wrap);
  }
}

// Render "used notes" pills ‚Äî show only actually played pitch classes
function renderUsedNotesPills(hist,keyRoot,targetEl,semi){
  targetEl.innerHTML='';
  const shiftedRoot=trR(keyRoot,semi);
  for(let i=0;i<12;i++){
    const origI=(i-semi%12+12)%12; // un-transpose to check if used
    const actualI=((i)%12+12)%12;
    if(hist[origI]===0)continue;
    const d=document.createElement('div');
    const isRoot=actualI===shiftedRoot;
    d.className='pill used'+(isRoot?' root':'');
    d.textContent=NM[actualI];
    targetEl.appendChild(d);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DOWNLOAD BUILDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildDownloads(semi){
  const song=$('songName').value.trim(),art=$('artistName').value.trim();
  const base=(song||'bass_tab').replace(/\s+/g,'_');
  const sfx=semi!==0?`_transposed${semi>0?'+':''}${semi}st`:'';

  // Standard PDF
  const blobStd=makePDF_TabOnly(gNotes,song,art,gKeyRoot,gKeyMode,semi);
  const urlStd=URL.createObjectURL(blobStd);
  $('dlStd').href=urlStd;$('dlStd').download=`${base}${sfx}_bass_tab.pdf`;

  // Lyrics PDF (only if lyrics exist)
  const lyricsLines=parseLyrics($('lyricsText').value);
  if(lyricsLines.length>0){
    const blobLyr=makePDF_WithLyrics(gNotes,song,art,gKeyRoot,gKeyMode,semi,lyricsLines);
    const urlLyr=URL.createObjectURL(blobLyr);
    $('dlLyr').href=urlLyr;$('dlLyr').download=`${base}${sfx}_bass_tab_lyrics.pdf`;
    $('dlLyr').style.display='';$('dlLyrNote').style.display='';
  } else {
    $('dlLyr').style.display='none';$('dlLyrNote').style.display='none';
  }

  const kr=NM[gKeyRoot],nr=NM[trR(gKeyRoot,semi)];
  const ks=semi!==0?`${kr} ‚Üí ${nr} ${gKeyMode}`:`${kr} ${gKeyMode}`;
  $('dlMeta').textContent=`${gNotes.length} notes ¬∑ A4 ¬∑ Standard tuning (E A D G) ¬∑ Key: ${ks}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRANSPOSE UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let gUsedHist=new Float64Array(12);

function updateXpDisplay(){
  const s=parseInt($('xpDir').value)||0;
  const nr=trR(gKeyRoot,s);
  $('xpTo').textContent=NM[nr];
  $('xpSemi').textContent=s===0?'0 semitones':`${s>0?'+':''}${s} semitone${Math.abs(s)>1?'s':''}`;
  $('tgtKey').value=String(nr);
  // Update transposed notes pills
  renderUsedNotesPills(gUsedHist,$('keyRoot')||gKeyRoot,$('xpNotesPills'),s);
  // Rebuild downloads with new transposition
  if(gNotes.length)buildDownloads(s);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Populate target key dropdown
NM.forEach((n,i)=>{const o=document.createElement('option');o.value=i;o.textContent=n;$('tgtKey').appendChild(o);});

// Dropzone
const drop=$('drop'),fileIn=$('fileIn');
drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('over');});
drop.addEventListener('dragleave',()=>drop.classList.remove('over'));
drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('over');if(e.dataTransfer.files[0])handleFile(e.dataTransfer.files[0]);});
fileIn.addEventListener('change',()=>{if(fileIn.files[0])handleFile(fileIn.files[0]);});

// Sync lyrics query when user types song/artist manually
$('songName').addEventListener('input',syncLyricsQuery);
$('artistName').addEventListener('input',syncLyricsQuery);

$('xpDir').addEventListener('change',()=>{
  const tgt=parseInt($('tgtKey').value);if(!isNaN(tgt)){}  // keep in sync
  updateXpDisplay();
});
$('tgtKey').addEventListener('change',()=>{
  const tgt=parseInt($('tgtKey').value);if(isNaN(tgt))return;
  let s=tgt-gKeyRoot;if(s>6)s-=12;if(s<-6)s+=12;
  const best=Array.from($('xpDir').options).find(o=>parseInt(o.value)===s);
  if(best)$('xpDir').value=String(s);
  updateXpDisplay();
});

function handleFile(f){
  if(!f.name.toLowerCase().endsWith('.mp3')&&!f.type.includes('mpeg')){showErr('Only MP3 files are accepted.');return;}
  // Always clear and update song name from new file
  const cleaned = f.name.replace(/\.mp3$/i,'').replace(/[-_\.]/g,' ').replace(/\b\w/g,c=>c.toUpperCase()).trim();
  $('songName').value = cleaned;

  // Sync lyrics search field + enable search button
  syncLyricsQuery();

  $('upWrap').classList.add('on');
  const badge=$('fileBadge');
  badge.textContent=`‚ñ∏ ${f.name}  (${(f.size/1048576).toFixed(2)} MB)`;
  badge.classList.add('on');
  const reader=new FileReader();
  reader.onprogress=e=>{
    if(e.lengthComputable){const p=Math.round(e.loaded/e.total*100);$('upFill').style.width=p+'%';$('upPct').textContent=p+'%';}
  };
  reader.onload=e=>{
    $('upFill').style.width='100%';$('upPct').textContent='100%';
    gAudioBuf=e.target.result;
    setTimeout(()=>$('upWrap').classList.remove('on'),700);
    $('procBtn').disabled=false;
    $('errBox').classList.remove('on');
    $('results').classList.remove('on');
  };
  reader.onerror=()=>showErr('Failed to read file.');
  reader.readAsArrayBuffer(f);
}

async function startExtraction(){
  if(!gAudioBuf)return;
  $('errBox').classList.remove('on');$('results').classList.remove('on');
  $('procBtn').disabled=true;$('anaWrap').classList.add('on');
  ['s1','s2','s3','s4','s5'].forEach(id=>ss(id,''));
  $('bigFill').style.width='0%';
  ss('s1','active');$('bigFill').style.width='5%';await tick();
  try{
    ss('s2','active');$('bigFill').style.width='12%';await tick();
    ss('s1','done');ss('s3','active');await tick();

    const notes=await extractNotes(gAudioBuf.slice(0),p=>{$('bigFill').style.width=p+'%';});
    gNotes=notes;
    if(!notes||notes.length===0)throw new Error('No pitched bass notes detected. Try an isolated bass track or DI recording.');

    ss('s3','done');ss('s4','active');$('bigFill').style.width='82%';await tick();

    const kr=detectKey(notes);
    gKeyRoot=kr.root;gKeyMode=kr.mode;
    gSongDuration=notes[notes.length-1].time+1;

    // Key display
    $('keyVal').textContent=NM[gKeyRoot];
    $('keyMd').textContent=(gKeyMode.charAt(0).toUpperCase()+gKeyMode.slice(1))+' scale';
    $('noteCnt').textContent=notes.length;
    $('keyCnf').textContent=kr.confidence+'%';
    const mx=notes[notes.length-1].time;
    $('songDur').textContent=Math.floor(mx/60)+':'+(Math.floor(mx%60)+'').padStart(2,'0');

    // Scale pills
    const scPills=$('scalePills');scPills.innerHTML='';
    const ints=gKeyMode==='major'?MAJ_INT:MIN_INT;
    ints.forEach((iv,i)=>{
      const d=document.createElement('div');
      d.className='pill'+(i===0?' root':'');
      d.textContent=NM[(gKeyRoot+iv)%12];
      scPills.appendChild(d);
    });

    // Chord chips
    const chEl=$('chordsEl');chEl.innerHTML='';
    getChords(gKeyRoot,gKeyMode).forEach(ch=>{
      const d=document.createElement('div');
      d.className='chord-chip'+(ch.tonic?' tonic':'');
      d.innerHTML=`<span class="chord-roman">${ch.roman}</span><span class="chord-name">${ch.name}</span><span class="chord-type">${ch.type}</span>`;
      chEl.appendChild(d);
    });

    // Notes used histogram & bars
    gUsedHist=getUsedNotes(notes);
    renderNoteBars(gUsedHist,gKeyRoot);

    // Used notes pills (original key)
    const upEl=$('usedNotesPills');upEl.innerHTML='';
    for(let i=0;i<12;i++){
      if(gUsedHist[i]===0)continue;
      const d=document.createElement('div');
      d.className='pill used'+(i===gKeyRoot?' root':'');
      d.textContent=NM[i];
      upEl.appendChild(d);
    }

    // Transpose init
    $('xpFrom').textContent=NM[gKeyRoot];
    $('xpTo').textContent=NM[gKeyRoot];
    $('xpDir').value='0';$('tgtKey').value=String(gKeyRoot);
    $('xpSemi').textContent='0 semitones';
    renderUsedNotesPills(gUsedHist,gKeyRoot,$('xpNotesPills'),0);

    ss('s4','done');ss('s5','active');$('bigFill').style.width='90%';await tick();

    // Build downloads
    buildDownloads(0);
    ss('s5','done');$('bigFill').style.width='100%';await tick();
    $('anaWrap').classList.remove('on');
    $('results').classList.add('on');
    $('results').scrollIntoView({behavior:'smooth',block:'start'});
  }catch(e){
    showErr(e.message);$('anaWrap').classList.remove('on');
  }
  $('procBtn').disabled=false;
}

function generateTransposedPDF(){
  if(!gNotes.length)return;
  const s=parseInt($('xpDir').value)||0;
  buildDownloads(s);
}

function resetForNewSong(){
  // Reset all state for a new song without reloading page
  gNotes=[];gKeyRoot=0;gKeyMode='major';gAudioBuf=null;gSongDuration=0;
  gUsedHist=new Float64Array(12);

  // Reset UI
  $('results').classList.remove('on');
  $('anaWrap').classList.remove('on');
  $('errBox').classList.remove('on');
  $('procBtn').disabled=true;
  $('bigFill').style.width='0%';
  ['s1','s2','s3','s4','s5'].forEach(id=>ss(id,''));

  // Reset form
  $('songName').value='';
  $('artistName').value='';
  $('lyricsText').value='';
  $('lyricsQuery').value='';
  $('lyricsCount').textContent='0 lines';
  $('lyricsEditNote').style.display='none';
  $('lyricsStatus').className='lyrics-status';
  $('lyricsStatusTxt').textContent='';
  $('lyricsSpinner').style.display='none';
  $('searchIcon').textContent='üîç';
  $('btnSearchLyr').disabled=true;
  $('fileBadge').textContent='';$('fileBadge').classList.remove('on');
  $('upFill').style.width='0%';$('upPct').textContent='0%';
  $('xpDir').value='0';

  // Reset file input so same file can be re-uploaded if needed
  fileIn.value='';

  // Scroll to top
  window.scrollTo({top:0,behavior:'smooth'});
}
</script>
</body>
</html>
