<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BassTAB ‚Äî Electric Bass Tablature Extractor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;0,700;1,300&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #0c0c0f;
  --bg2: #13131a;
  --surface: #1a1a24;
  --surface2: #22222f;
  --border: #2a2a3a;
  --border2: #38384f;
  --accent: #7c6af7;
  --accent-light: #a89bff;
  --accent-dim: rgba(124,106,247,0.13);
  --gold: #f0c060;
  --gold-dim: rgba(240,192,96,0.12);
  --green: #4ecb8d;
  --green-dim: rgba(78,203,141,0.10);
  --red: #f06060;
  --fg: #eeeaf8;
  --fg2: #aaa8c0;
  --fg3: #6b6888;
  --r: 10px;
  --r-lg: 16px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }

body {
  background: var(--bg);
  color: var(--fg);
  font-family: 'JetBrains Mono', monospace;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: -20vh; left: 50%;
  transform: translateX(-50%);
  width: 100vw; height: 70vh;
  background: radial-gradient(ellipse 60% 50% at 50% 0%, rgba(124,106,247,0.06) 0%, transparent 100%);
  pointer-events: none;
  z-index: 0;
}

.wrap {
  width: 100%; max-width: 740px;
  padding: 0 24px 100px;
  position: relative; z-index: 1;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.hdr {
  padding: 60px 0 50px;
}
.hdr-top {
  display: flex;
  align-items: baseline;
  gap: 16px;
  flex-wrap: wrap;
  margin-bottom: 14px;
}
.logo {
  font-family: 'Syne', sans-serif;
  font-size: clamp(56px, 12vw, 96px);
  font-weight: 800;
  letter-spacing: -0.03em;
  line-height: 1;
  color: var(--fg);
}
.logo-badge {
  font-family: 'Syne', sans-serif;
  font-size: clamp(16px, 3.5vw, 24px);
  font-weight: 600;
  color: var(--accent-light);
  letter-spacing: 0.04em;
  padding: 4px 12px;
  background: var(--accent-dim);
  border: 1px solid rgba(124,106,247,0.25);
  border-radius: 6px;
}
.tagline {
  font-size: 12px;
  color: var(--fg3);
  letter-spacing: 0.14em;
  text-transform: uppercase;
  font-weight: 300;
}
.hdr-rule {
  width: 100%; height: 1px;
  background: linear-gradient(90deg, var(--accent) 0%, rgba(124,106,247,0) 70%);
  margin-top: 18px;
  opacity: 0.35;
}

/* ‚îÄ‚îÄ Section labels ‚îÄ‚îÄ */
.sec-label {
  font-family: 'Syne', sans-serif;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.22em;
  text-transform: uppercase;
  color: var(--fg3);
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.sec-label::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}
.sec { margin-bottom: 22px; }

/* ‚îÄ‚îÄ Drop Zone ‚îÄ‚îÄ */
.drop {
  border: 1.5px dashed var(--border2);
  border-radius: var(--r-lg);
  padding: 56px 32px 46px;
  text-align: center;
  cursor: pointer;
  transition: border-color .25s, background .25s, transform .2s;
  position: relative;
  overflow: hidden;
  background: var(--bg2);
}
.drop:hover, .drop.over { border-color: var(--accent); background: var(--accent-dim); transform: translateY(-2px); }
.drop input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
.drop-ico { font-size: 46px; display: block; margin-bottom: 20px; filter: drop-shadow(0 0 18px rgba(124,106,247,0.35)); }
.drop-title { font-family: 'Syne', sans-serif; font-size: 21px; font-weight: 700; margin-bottom: 10px; }
.drop-hint { font-size: 12px; color: var(--fg3); letter-spacing: 0.05em; line-height: 1.8; }
.drop-hint b { color: var(--accent-light); font-weight: 500; }
.file-badge {
  display: none; margin-top: 20px;
  padding: 10px 18px;
  background: var(--accent-dim); border: 1px solid var(--accent);
  border-radius: 6px; font-size: 12px; color: var(--accent-light);
}
.file-badge.on { display: inline-block; }

/* ‚îÄ‚îÄ Upload Progress ‚îÄ‚îÄ */
.up-wrap { display: none; margin-top: 18px; }
.up-wrap.on { display: block; }
.up-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
.up-lbl { font-size: 11px; letter-spacing: 0.12em; color: var(--fg3); text-transform: uppercase; }
.up-pct { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; color: var(--accent-light); }
.track { width: 100%; height: 4px; background: var(--border); border-radius: 999px; overflow: hidden; }
.fill {
  height: 100%; border-radius: 999px;
  background: linear-gradient(90deg, var(--accent), var(--accent-light));
  width: 0%; transition: width .35s ease;
}

/* ‚îÄ‚îÄ Meta inputs ‚îÄ‚îÄ */
.meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.fld { display: flex; flex-direction: column; gap: 8px; }
.fld-lbl { font-size: 11px; letter-spacing: 0.14em; text-transform: uppercase; color: var(--fg3); }
.fld-inp, .fld-sel {
  background: var(--surface); border: 1.5px solid var(--border);
  border-radius: var(--r); color: var(--fg);
  font-family: 'JetBrains Mono', monospace; font-size: 14px;
  padding: 13px 16px; outline: none;
  transition: border-color .2s, background .2s; width: 100%;
}
.fld-inp:focus, .fld-sel:focus { border-color: var(--accent); background: var(--surface2); }
.fld-inp::placeholder { color: var(--fg3); }
.fld-sel {
  cursor: pointer; -webkit-appearance: none; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b6888' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 14px center;
  background-color: var(--surface); padding-right: 38px;
}
.fld-sel option { background: #1a1a24; }

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn-main {
  width: 100%; padding: 18px;
  background: linear-gradient(135deg, var(--accent) 0%, #5a48d0 100%);
  color: white; border: none; border-radius: var(--r);
  font-family: 'Syne', sans-serif; font-size: 17px; font-weight: 700;
  letter-spacing: 0.09em; cursor: pointer;
  transition: opacity .2s, transform .2s, box-shadow .2s;
  box-shadow: 0 4px 28px rgba(124,106,247,0.28);
}
.btn-main:hover:not(:disabled) { opacity: .9; transform: translateY(-2px); box-shadow: 0 8px 36px rgba(124,106,247,0.38); }
.btn-main:disabled { opacity: .3; cursor: not-allowed; transform: none; box-shadow: none; }

.btn-outline {
  padding: 14px 24px; background: transparent;
  border: 1.5px solid var(--accent); border-radius: var(--r);
  color: var(--accent-light); font-family: 'Syne', sans-serif;
  font-size: 14px; font-weight: 700; letter-spacing: 0.08em;
  cursor: pointer; transition: background .2s, color .2s, transform .2s;
  display: inline-flex; align-items: center; gap: 8px; white-space: nowrap;
}
.btn-outline:hover { background: var(--accent); color: white; transform: translateY(-1px); }

.btn-dl {
  padding: 14px 28px; background: var(--green); border: none;
  border-radius: var(--r); color: #0a1a10;
  font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700;
  letter-spacing: 0.07em; cursor: pointer; text-decoration: none;
  display: inline-flex; align-items: center; gap: 8px;
  transition: opacity .2s, transform .2s; white-space: nowrap;
}
.btn-dl:hover { opacity: .9; transform: translateY(-1px); }

/* ‚îÄ‚îÄ Analysis Progress ‚îÄ‚îÄ */
.analysis-wrap {
  display: none; background: var(--surface);
  border: 1px solid var(--border); border-radius: var(--r-lg);
  padding: 32px; margin-top: 20px;
}
.analysis-wrap.on { display: block; }
.analysis-title { font-family: 'Syne', sans-serif; font-size: 17px; font-weight: 700; margin-bottom: 24px; }
.steps { display: flex; flex-direction: column; gap: 14px; }
.step { display: flex; align-items: center; gap: 16px; opacity: .3; transition: opacity .3s; }
.step.active { opacity: 1; }
.step.done { opacity: .65; }
.step-num {
  width: 30px; height: 30px; border-radius: 50%;
  background: var(--border); border: 2px solid var(--border2);
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 700; color: var(--fg3); flex-shrink: 0;
  transition: background .3s, border-color .3s, color .3s;
}
.step.active .step-num {
  background: var(--accent-dim); border-color: var(--accent); color: var(--accent-light);
  animation: pd 1.4s ease-in-out infinite;
}
.step.done .step-num { background: var(--green-dim); border-color: var(--green); color: var(--green); }
@keyframes pd {
  0%,100% { box-shadow: 0 0 0 0 rgba(124,106,247,.4); }
  50% { box-shadow: 0 0 0 7px rgba(124,106,247,0); }
}
.step-txt { font-size: 13px; color: var(--fg2); }
.step.active .step-txt { color: var(--fg); }
.big-track { width: 100%; height: 6px; background: var(--border); border-radius: 999px; overflow: hidden; margin-top: 28px; }
.big-fill {
  height: 100%; border-radius: 999px;
  background: linear-gradient(90deg, var(--accent), var(--accent-light));
  width: 0%; transition: width .5s ease;
}

/* ‚îÄ‚îÄ Results ‚îÄ‚îÄ */
.results { display: none; }
.results.on { display: block; }

/* Key Card */
.key-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r-lg); padding: 30px; margin-bottom: 14px;
  position: relative; overflow: hidden;
}
.key-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, var(--gold) 0%, transparent 60%);
}
.key-top {
  display: flex; align-items: flex-start;
  justify-content: space-between; gap: 24px; flex-wrap: wrap; margin-bottom: 26px;
}
.key-main { display: flex; flex-direction: column; gap: 4px; }
.key-lbl { font-size: 11px; letter-spacing: 0.18em; color: var(--fg3); text-transform: uppercase; }
.key-val {
  font-family: 'Syne', sans-serif; font-size: 56px; font-weight: 800;
  color: var(--gold); line-height: 1; letter-spacing: -0.02em;
}
.key-mode { font-size: 14px; color: var(--fg2); margin-top: 4px; }
.key-stats { display: flex; flex-direction: column; gap: 8px; align-items: flex-end; }
.key-stat { font-size: 12px; color: var(--fg3); text-align: right; }
.key-stat strong { color: var(--fg2); font-weight: 400; }

.sub-title { font-size: 10px; letter-spacing: 0.18em; color: var(--fg3); text-transform: uppercase; margin-bottom: 14px; }

.scale-pills { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 26px; }
.scale-pill {
  padding: 6px 13px; background: var(--bg);
  border: 1px solid var(--border2); border-radius: 6px;
  font-size: 13px; color: var(--fg2);
}
.scale-pill.root {
  background: var(--gold-dim); border-color: var(--gold);
  color: var(--gold); font-weight: 600;
}

.chords { display: flex; gap: 10px; flex-wrap: wrap; }
.chord-chip {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  padding: 12px 14px; background: var(--bg);
  border: 1px solid var(--border2); border-radius: var(--r); min-width: 54px;
  transition: border-color .2s, transform .2s;
  cursor: default;
}
.chord-chip:hover { border-color: var(--accent); transform: translateY(-2px); }
.chord-chip.tonic { background: var(--gold-dim); border-color: rgba(240,192,96,0.3); }
.chord-roman { font-size: 10px; color: var(--fg3); letter-spacing: 0.06em; }
.chord-name { font-family: 'Syne', sans-serif; font-size: 17px; font-weight: 700; color: var(--fg); }
.chord-chip.tonic .chord-name { color: var(--gold); }
.chord-type { font-size: 9px; color: var(--fg3); }

/* Transpose card */
.xp-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r-lg); padding: 30px; margin-bottom: 14px;
}
.xp-controls { display: grid; grid-template-columns: 1fr 1fr auto; gap: 14px; align-items: end; }
.xp-display {
  display: flex; align-items: center; justify-content: center;
  gap: 10px; padding: 22px 0; margin-top: 18px;
  border-top: 1px solid var(--border);
}
.xp-key-wrap { display: flex; flex-direction: column; align-items: center; gap: 5px; }
.xp-key-lbl { font-size: 10px; letter-spacing: 0.14em; color: var(--fg3); text-transform: uppercase; }
.xp-key-from { font-family: 'Syne', sans-serif; font-size: 32px; font-weight: 800; color: var(--fg2); }
.xp-key-to   { font-family: 'Syne', sans-serif; font-size: 32px; font-weight: 800; color: var(--accent-light); }
.xp-mid { display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 0 18px; }
.xp-arrow { font-size: 20px; color: var(--fg3); }
.xp-semi-badge {
  font-size: 11px; color: var(--fg3);
  padding: 4px 10px; background: var(--bg);
  border-radius: 6px; border: 1px solid var(--border);
}

/* Download card */
.dl-card {
  background: var(--green-dim); border: 1px solid var(--green);
  border-radius: var(--r-lg); padding: 26px 28px;
  display: flex; align-items: center; justify-content: space-between;
  gap: 20px; flex-wrap: wrap;
}
.dl-info { flex: 1; min-width: 200px; }
.dl-status { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
.dl-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: blink 2s ease infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.35} }
.dl-status-txt { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; color: var(--green); }
.dl-meta { font-size: 11px; color: var(--fg3); }

/* Error */
.err {
  display: none; background: rgba(240,96,96,.08);
  border: 1px solid var(--red); border-radius: var(--r);
  padding: 16px 20px; font-size: 13px; color: var(--red);
  line-height: 1.6; margin-top: 16px;
}
.err.on { display: block; }

/* Info tiles */
.tiles {
  display: grid; grid-template-columns: repeat(4, 1fr);
  gap: 10px; margin-top: 36px;
}
.tile {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--r); padding: 18px 16px;
}
.tile-lbl { font-size: 10px; letter-spacing: 0.16em; color: var(--fg3); text-transform: uppercase; margin-bottom: 8px; }
.tile-val { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 600; color: var(--fg); line-height: 1.3; }
.tile-sub { font-size: 10px; color: var(--fg3); margin-top: 3px; }

/* Responsive */
@media (max-width: 600px) {
  .meta-grid { grid-template-columns: 1fr; }
  .xp-controls { grid-template-columns: 1fr 1fr; }
  .xp-controls .btn-outline { grid-column: 1 / -1; width: 100%; justify-content: center; }
  .tiles { grid-template-columns: repeat(2,1fr); }
  .dl-card { flex-direction: column; align-items: flex-start; }
  .btn-dl { width: 100%; justify-content: center; }
  .key-top { flex-direction: column; }
  .key-stats { align-items: flex-start; }
}
@media (max-width: 420px) {
  .wrap { padding: 0 16px 60px; }
  .drop { padding: 40px 20px 32px; }
  .logo { font-size: 48px; }
}
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <header class="hdr">
    <div class="hdr-top">
      <span class="logo">BassTAB</span>
      <span class="logo-badge">Extractor</span>
    </div>
    <p class="tagline">MP3 ‚Üí Electric bass tablature ‚Üí PDF ¬∑ Client-side ¬∑ Standard tuning E A D G</p>
    <div class="hdr-rule"></div>
  </header>

  <!-- 01 Upload -->
  <div class="sec">
    <div class="sec-label">01 ¬∑ Upload</div>
    <div class="drop" id="drop">
      <input type="file" id="fileIn" accept=".mp3,audio/mpeg">
      <span class="drop-ico">üé∏</span>
      <div class="drop-title">Drop your MP3 here</div>
      <div class="drop-hint">
        Click to browse or drag &amp; drop<br>
        <b>Best results</b> with isolated bass, stems or DI recordings ¬∑ Max 50 MB
      </div>
      <div class="file-badge" id="fileBadge"></div>
    </div>

    <div class="up-wrap" id="upWrap">
      <div class="up-row">
        <span class="up-lbl">Reading file</span>
        <span class="up-pct" id="upPct">0%</span>
      </div>
      <div class="track"><div class="fill" id="upFill"></div></div>
    </div>
  </div>

  <!-- 02 Song Info -->
  <div class="sec">
    <div class="sec-label">02 ¬∑ Song Info</div>
    <div class="meta-grid">
      <div class="fld">
        <label class="fld-lbl" for="songName">Song title</label>
        <input class="fld-inp" type="text" id="songName" placeholder="Enter song title‚Ä¶">
      </div>
      <div class="fld">
        <label class="fld-lbl" for="artistName">Artist</label>
        <input class="fld-inp" type="text" id="artistName" placeholder="Enter artist name‚Ä¶">
      </div>
    </div>
  </div>

  <!-- Extract -->
  <div class="sec">
    <button class="btn-main" id="procBtn" disabled onclick="startExtraction()">
      Analyze &amp; Extract Bass Tab
    </button>
    <div class="err" id="errBox"></div>
  </div>

  <!-- Analysis progress -->
  <div class="analysis-wrap" id="anaWrap">
    <div class="analysis-title">Analyzing audio‚Ä¶</div>
    <div class="steps">
      <div class="step" id="s1"><div class="step-num">1</div><span class="step-txt">Decoding MP3 and reading audio data</span></div>
      <div class="step" id="s2"><div class="step-num">2</div><span class="step-txt">Applying low-pass filter ‚Äî bass isolation</span></div>
      <div class="step" id="s3"><div class="step-num">3</div><span class="step-txt">YIN pitch detection ‚Äî frame-by-frame analysis</span></div>
      <div class="step" id="s4"><div class="step-num">4</div><span class="step-txt">Detecting key, scale and diatonic chord progression</span></div>
      <div class="step" id="s5"><div class="step-num">5</div><span class="step-txt">Generating A4 tablature PDF</span></div>
    </div>
    <div class="big-track"><div class="big-fill" id="bigFill"></div></div>
  </div>

  <!-- Results -->
  <div class="results" id="results">

    <div class="sec-label" style="margin-top:8px">Analysis</div>

    <!-- Key card -->
    <div class="key-card">
      <div class="key-top">
        <div class="key-main">
          <span class="key-lbl">Detected Key</span>
          <div class="key-val" id="keyVal">‚Äî</div>
          <div class="key-mode" id="keyMd">‚Äî</div>
        </div>
        <div class="key-stats">
          <div class="key-stat">Notes: <strong id="noteCnt">‚Äî</strong></div>
          <div class="key-stat">Duration: <strong id="songDur">‚Äî</strong></div>
          <div class="key-stat">Confidence: <strong id="keyCnf">‚Äî</strong></div>
        </div>
      </div>

      <div class="sub-title">Scale notes</div>
      <div class="scale-pills" id="scalePills"></div>

      <div class="sub-title">Diatonic chord progression</div>
      <div class="chords" id="chordsEl"></div>
    </div>

    <!-- 03 Transpose -->
    <div class="sec-label" style="margin-top:20px">03 ¬∑ Transpose</div>
    <div class="xp-card">
      <div class="xp-controls">
        <div class="fld">
          <label class="fld-lbl" for="xpDir">Semitones / direction</label>
          <select class="fld-sel" id="xpDir">
            <option value="0">No transposition (0 st)</option>
            <option value="1">+1 semitone</option>
            <option value="2">+2 semitones  (1 tone)</option>
            <option value="3">+3 semitones</option>
            <option value="4">+4 semitones  (2 tones)</option>
            <option value="5">+5 semitones</option>
            <option value="6">+6 semitones  (tritone)</option>
            <option value="7">+7 semitones  (5th ‚Üë)</option>
            <option value="-1">‚àí1 semitone</option>
            <option value="-2">‚àí2 semitones  (1 tone)</option>
            <option value="-3">‚àí3 semitones</option>
            <option value="-4">‚àí4 semitones  (2 tones)</option>
            <option value="-5">‚àí5 semitones</option>
            <option value="-6">‚àí6 semitones</option>
            <option value="-7">‚àí7 semitones  (4th ‚Üì)</option>
          </select>
        </div>
        <div class="fld">
          <label class="fld-lbl" for="tgtKey">Target key</label>
          <select class="fld-sel" id="tgtKey">
            <option value="">‚Äî auto from semitones ‚Äî</option>
          </select>
        </div>
        <button class="btn-outline" onclick="generateTransposedPDF()">‚Üì Generate PDF</button>
      </div>

      <div class="xp-display">
        <div class="xp-key-wrap">
          <span class="xp-key-lbl">Original</span>
          <span class="xp-key-from" id="xpFrom">‚Äî</span>
        </div>
        <div class="xp-mid">
          <span class="xp-arrow">‚Üí</span>
          <span class="xp-semi-badge" id="xpSemi">0 semitones</span>
        </div>
        <div class="xp-key-wrap">
          <span class="xp-key-lbl">Transposed</span>
          <span class="xp-key-to" id="xpTo">‚Äî</span>
        </div>
      </div>
    </div>

    <!-- Download -->
    <div class="dl-card" id="dlCard">
      <div class="dl-info">
        <div class="dl-status"><div class="dl-dot"></div><span class="dl-status-txt">Tablature ready</span></div>
        <div class="dl-meta" id="dlMeta">‚Äî</div>
      </div>
      <a class="btn-dl" id="dlLink" href="#" download>‚Üì Download PDF</a>
    </div>

  </div><!-- /results -->

  <!-- Info tiles -->
  <div class="tiles">
    <div class="tile"><div class="tile-lbl">Tuning</div><div class="tile-val">E ¬∑ A ¬∑ D ¬∑ G</div><div class="tile-sub">Standard 4-string</div></div>
    <div class="tile"><div class="tile-lbl">Algorithm</div><div class="tile-val">YIN</div><div class="tile-sub">Time-domain pitch detection</div></div>
    <div class="tile"><div class="tile-lbl">Output</div><div class="tile-val">A4 PDF</div><div class="tile-sub">Printable tablature</div></div>
    <div class="tile"><div class="tile-lbl">Processing</div><div class="tile-val">Client-side</div><div class="tile-sub">No server ¬∑ No data sent</div></div>
  </div>

</div><!-- /wrap -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const NM  = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const STR = [{ name:"G", midi:43 },{ name:"D", midi:38 },{ name:"A", midi:33 },{ name:"E", midi:28 }];

const KS_MAJ = [6.35,2.23,3.48,2.33,4.38,4.09,2.52,5.19,2.39,3.66,2.29,2.88];
const KS_MIN = [6.33,2.68,3.52,5.38,2.60,3.53,2.54,4.75,3.98,2.69,3.34,3.17];

const MAJ_INT    = [0,2,4,5,7,9,11];
const MIN_INT    = [0,2,3,5,7,8,10];
const MAJ_TYPES  = ["maj","min","min","maj","maj","min","dim"];
const MIN_TYPES  = ["min","dim","maj","min","min","maj","maj"];
const MAJ_ROMAN  = ["I","ii","iii","IV","V","vi","vii¬∞"];
const MIN_ROMAN  = ["i","ii¬∞","III","iv","v","VI","VII"];

// Global state
let gNotes = [], gKeyRoot = 0, gKeyMode = 'major', gAudioBuf = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MUSIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const f2m  = f  => 69 + 12 * Math.log2(f/440);
const m2nn = m  => NM[((Math.round(m)%12)+12)%12] + (Math.floor(m/12)-1);
const pc   = m  => ((Math.round(m)%12)+12)%12;
const trR  = (r,s) => ((r+s)%12+12)%12;

function midiToTab(midi) {
  let best = null, bf = 999;
  for (const s of STR) {
    const f = Math.round(midi) - s.midi;
    if (f>=0 && f<=24 && f<bf) { bf=f; best={string:s.name,fret:f}; }
  }
  return best;
}

function detectKey(notes) {
  const h = new Float64Array(12);
  let tot = 0;
  for (const n of notes) { h[pc(n.midi)] += n.duration; tot += n.duration; }
  if (!tot) return { root:0, mode:'major', confidence:0 };
  for (let i=0;i<12;i++) h[i]/=tot;

  let best=-Infinity, root=0, mode='major';
  for (let r=0;r<12;r++) {
    let sm=0, sn=0;
    for (let i=0;i<12;i++) { sm += h[(i+r)%12]*KS_MAJ[i]; sn += h[(i+r)%12]*KS_MIN[i]; }
    if (sm>best){best=sm;root=r;mode='major';}
    if (sn>best){best=sn;root=r;mode='minor';}
  }
  return { root, mode, confidence: Math.min(99, Math.round(best*180)) };
}

function getChords(root, mode) {
  const ints  = mode==='major'?MAJ_INT:MIN_INT;
  const types = mode==='major'?MAJ_TYPES:MIN_TYPES;
  const romans= mode==='major'?MAJ_ROMAN:MIN_ROMAN;
  return ints.map((iv,d)=>({ root:(root+iv)%12, name:NM[(root+iv)%12], type:types[d], roman:romans[d], tonic:d===0 }));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// YIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function yinPitch(buf, sr, thr=0.12) {
  const W = buf.length, half = Math.floor(W/2);
  const d = new Float32Array(half);
  for (let t=1;t<half;t++){let s=0;for(let j=0;j<half;j++){const x=buf[j]-buf[j+t];s+=x*x;}d[t]=s;}
  const c = new Float32Array(half); c[0]=1;
  let run=0;
  for(let t=1;t<half;t++){run+=d[t];c[t]=run>0?d[t]*t/run:1;}
  const lo=Math.floor(sr/196), hi=Math.min(Math.floor(sr/41),half-2);
  let t=lo;
  while(t<hi){if(c[t]<thr){while(t+1<hi&&c[t+1]<c[t])t++;break;}t++;}
  if(t>=hi||c[t]>=thr)return null;
  let bt=t;
  if(t>0&&t<half-1){const s0=c[t-1],s1=c[t],s2=c[t+1],dn=2*(2*s1-s2-s0);if(Math.abs(dn)>1e-10)bt=t+(s2-s0)/dn;}
  return sr/bt;
}

function lpf(input, sr, cutoff) {
  const a=1/(1+sr/(2*Math.PI*cutoff)), out=new Float32Array(input.length);
  out[0]=input[0];
  for(let i=1;i<input.length;i++) out[i]=out[i-1]+a*(input[i]-out[i-1]);
  return out;
}

async function extractNotes(buf, onPct) {
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const ab  = await ctx.decodeAudioData(buf.slice(0));
  const nCh=ab.numberOfChannels, len=ab.length, sr=ab.sampleRate;
  const mono=new Float32Array(len);
  for(let c=0;c<nCh;c++){const ch=ab.getChannelData(c);for(let i=0;i<len;i++)mono[i]+=ch[i]/nCh;}
  ctx.close();
  const filt=lpf(mono,sr,280);
  const HOP=Math.floor(sr*.04), WIN=Math.floor(sr*.08);
  const tot=Math.floor((len-WIN)/HOP), ft=HOP/sr;
  const raw=[]; let pm=null,ns=0,nd=0;
  for(let fi=0;fi<tot;fi++){
    if(fi%80===0) onPct(10+(fi/tot)*70);
    const frame=filt.slice(fi*HOP,fi*HOP+WIN);
    let rms=0; for(const s of frame)rms+=s*s; rms=Math.sqrt(rms/frame.length);
    const t=fi*ft;
    if(rms<0.002){if(pm!==null){if(nd>=.06)raw.push({time:ns,duration:nd,midi:pm});pm=null;}continue;}
    const freq=yinPitch(frame,sr,0.11);
    if(!freq){if(pm!==null){if(nd>=.06)raw.push({time:ns,duration:nd,midi:pm});pm=null;}continue;}
    const m=Math.round(f2m(freq));
    if(m<28||m>51){if(pm!==null){if(nd>=.06)raw.push({time:ns,duration:nd,midi:pm});pm=null;}continue;}
    if(m===pm){nd+=ft;}else{if(pm!==null&&nd>=.06)raw.push({time:ns,duration:nd,midi:pm});pm=m;ns=t;nd=ft;}
  }
  if(pm!==null&&nd>=.06)raw.push({time:ns,duration:nd,midi:pm});
  return raw.map(n=>{const tab=midiToTab(n.midi);return tab?{...n,noteName:m2nn(n.midi),string:tab.string,fret:tab.fret}:null;}).filter(Boolean);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function makePDF(notes, song, artist, keyRoot, keyMode, semi) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
  const PW=595.28, PH=841.89, ML=40, MR=40, CW=PW-ML-MR;

  const newRoot = trR(keyRoot, semi);
  const keyStr  = NM[keyRoot]+' '+keyMode;
  const xpStr   = semi!==0 ? `  ‚Üí  ${NM[newRoot]} ${keyMode}  (${semi>0?'+':''}${semi} st)` : '';
  const info    = `Key: ${keyStr}${xpStr}`;

  function drawPageHeader() {
    // Top border
    doc.setDrawColor(210,205,230); doc.setLineWidth(0.4); doc.line(ML,20,PW-MR,20);

    const HY=44;
    doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(110,108,130);
    doc.text('SONG', ML, HY);
    const slw=doc.getTextWidth('SONG'), sls=ML+slw+5, sle=ML+210;
    if(song){ doc.setFont('helvetica','italic'); doc.setFontSize(9); doc.setTextColor(20,20,35); doc.text(song,sls+2,HY-1); doc.setFont('helvetica','normal'); }
    doc.setDrawColor(60,58,90); doc.setLineWidth(0.5); doc.line(sls,HY+2,sle,HY+2);

    const ax=ML+240;
    doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(110,108,130);
    doc.text('ARTIST',ax,HY);
    const alw=doc.getTextWidth('ARTIST'), als=ax+alw+5, ale=PW-MR;
    if(artist){ doc.setFont('helvetica','italic'); doc.setFontSize(9); doc.setTextColor(20,20,35); doc.text(artist,als+2,HY-1); doc.setFont('helvetica','normal'); }
    doc.line(als,HY+2,ale,HY+2);

    // Key info
    doc.setFont('helvetica','normal'); doc.setFontSize(7.5); doc.setTextColor(120,100,190);
    doc.text(info, PW/2, HY+13, { align:'center' });

    // Sub-rule
    doc.setDrawColor(200,196,220); doc.setLineWidth(0.35); doc.line(ML,HY+20,PW-MR,HY+20);
  }

  // Staff geometry
  const TW=13, SSX=ML+TW+4, SSW=CW-TW-4;
  const SS=11, SH=SS*3, MPR=4, MW=SSW/MPR;
  const FIRST_Y=86, ROW_STEP=SH+34;
  const ROWS_PG=Math.floor((PH-FIRST_Y-24)/ROW_STEP);

  let bpm=100;
  if(notes.length>4){const sp=notes[notes.length-1].time-notes[0].time; bpm=Math.max(60,Math.min(160,Math.round(notes.length/sp*28)));}
  const MD=(60/bpm)*4, RD=MD*MPR;
  const maxT=notes.length>0?notes[notes.length-1].time+1:1;
  const totalRows=Math.ceil(maxT/RD);
  const SLABELS=['G','D','A','E'], SMAP={G:0,D:1,A:2,E:3};

  function drawStaff(ri, yTop) {
    const mn=ri*MPR+1;
    doc.setFont('helvetica','italic'); doc.setFontSize(6.5); doc.setTextColor(140,132,175);
    doc.text(String(mn), ML, yTop-3);

    // String name labels
    doc.setFont('helvetica','bold'); doc.setFontSize(6.5); doc.setTextColor(100,95,140);
    for(let si=0;si<4;si++) doc.text(SLABELS[si], ML+TW-2, yTop+si*SS+2.5, {align:'center'});

    // Horizontal lines
    doc.setDrawColor(50,48,75); doc.setLineWidth(0.35);
    for(let si=0;si<4;si++) doc.line(SSX, yTop+si*SS, SSX+SSW, yTop+si*SS);

    // Bar lines
    for(let bi=0;bi<=MPR;bi++){
      const bx=SSX+bi*MW;
      doc.setLineWidth(bi===0||bi===MPR?1.1:0.5);
      doc.setDrawColor(50,48,75);
      doc.line(bx,yTop,bx,yTop+SH);
    }

    // TAB label
    doc.setFont('helvetica','bold'); doc.setFontSize(7); doc.setTextColor(110,100,155);
    const tx=ML+TW/2;
    doc.text('T',tx,yTop+1,{align:'center'});
    doc.text('A',tx,yTop+SS+1,{align:'center'});
    doc.text('B',tx,yTop+SS*2+1,{align:'center'});
  }

  function drawNote(note, rStart, yTop, semi) {
    const rel=note.time-rStart;
    if(rel<0||rel>=RD)return;
    const transM=note.midi+semi;
    const tab=midiToTab(transM);
    if(!tab)return;
    const nx=SSX+(rel/RD)*SSW;
    const si=SMAP[tab.string]??3;
    const ny=yTop+si*SS;
    const fs=String(tab.fret), fw=fs.length>1?10:7;
    doc.setFillColor(255,255,255);
    doc.rect(nx-fw/2-1,ny-5.8,fw+2,8,'F');
    doc.setFont('helvetica','bold'); doc.setFontSize(7.5); doc.setTextColor(0,0,0);
    doc.text(fs,nx,ny+1.8,{align:'center'});
  }

  // Render pages
  let curPg=0; drawPageHeader();
  for(let ri=0;ri<totalRows;ri++){
    const pg=Math.floor(ri/ROWS_PG);
    if(pg>curPg){ doc.addPage(); curPg=pg; drawPageHeader(); }
    const lr=ri%ROWS_PG, yTop=FIRST_Y+lr*ROW_STEP;
    drawStaff(ri,yTop);
    const rs=ri*RD, re=rs+RD;
    notes.filter(n=>n.time>=rs&&n.time<re).forEach(n=>drawNote(n,rs,yTop,semi));
  }

  // Footer
  const tp=doc.getNumberOfPages();
  for(let p=1;p<=tp;p++){
    doc.setPage(p);
    doc.setDrawColor(190,186,210); doc.setLineWidth(0.3); doc.line(ML,PH-22,PW-MR,PH-22);
    doc.setFont('helvetica','normal'); doc.setFontSize(7); doc.setTextColor(160,155,185);
    doc.text(`Page ${p} / ${tp}`,PW/2,PH-13,{align:'center'});
  }
  return doc.output('blob');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const $=id=>document.getElementById(id);

// Populate target key dropdown
NM.forEach((n,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=n; $('tgtKey').appendChild(o); });

// Drop zone
const drop=$('drop'), fileIn=$('fileIn');
drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('over');});
drop.addEventListener('dragleave',()=>drop.classList.remove('over'));
drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('over');if(e.dataTransfer.files[0])handleFile(e.dataTransfer.files[0]);});
fileIn.addEventListener('change',()=>{if(fileIn.files[0])handleFile(fileIn.files[0]);});

function handleFile(f) {
  if(!f.name.toLowerCase().endsWith('.mp3')&&!f.type.includes('mpeg')){showErr('Only MP3 files are accepted.');return;}
  $('upWrap').classList.add('on');
  const badge=$('fileBadge');
  badge.textContent=`‚ñ∏ ${f.name}  (${(f.size/1048576).toFixed(2)} MB)`;
  badge.classList.add('on');
  const reader=new FileReader();
  reader.onprogress=e=>{
    if(e.lengthComputable){const p=Math.round(e.loaded/e.total*100);$('upFill').style.width=p+'%';$('upPct').textContent=p+'%';}
  };
  reader.onload=e=>{
    $('upFill').style.width='100%';$('upPct').textContent='100%';
    gAudioBuf=e.target.result;
    setTimeout(()=>$('upWrap').classList.remove('on'),700);
    $('procBtn').disabled=false;
    $('errBox').classList.remove('on');
    $('results').classList.remove('on');
    if(!$('songName').value) $('songName').value=f.name.replace(/\.mp3$/i,'').replace(/[-_]/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
  };
  reader.onerror=()=>showErr('Failed to read file.');
  reader.readAsArrayBuffer(f);
}

function showErr(msg){const e=$('errBox');e.textContent='‚ö† '+msg;e.classList.add('on');}
const tick=()=>new Promise(r=>setTimeout(r,40));

function ss(id,st){const e=$(id);e.classList.remove('active','done');if(st)e.classList.add(st);}

async function startExtraction(){
  if(!gAudioBuf)return;
  $('errBox').classList.remove('on');$('results').classList.remove('on');
  $('procBtn').disabled=true;$('anaWrap').classList.add('on');
  ['s1','s2','s3','s4','s5'].forEach(id=>ss(id,''));
  $('bigFill').style.width='0%';

  ss('s1','active');$('bigFill').style.width='5%';await tick();
  try{
    ss('s2','active');$('bigFill').style.width='12%';await tick();
    ss('s1','done');ss('s3','active');await tick();

    const notes=await extractNotes(gAudioBuf.slice(0),p=>{$('bigFill').style.width=p+'%';});
    gNotes=notes;
    if(!notes||notes.length===0) throw new Error('No pitched bass notes detected. Try an isolated bass track or DI recording.');

    ss('s3','done');ss('s4','active');$('bigFill').style.width='82%';await tick();

    const kr=detectKey(notes);
    gKeyRoot=kr.root;gKeyMode=kr.mode;

    $('keyVal').textContent=NM[gKeyRoot];
    $('keyMd').textContent=(gKeyMode.charAt(0).toUpperCase()+gKeyMode.slice(1))+' scale';
    $('noteCnt').textContent=notes.length;
    $('keyCnf').textContent=kr.confidence+'%';
    const mx=notes[notes.length-1].time;
    $('songDur').textContent=Math.floor(mx/60)+':'+(Math.floor(mx%60)+'').padStart(2,'0');

    // Scale pills
    const scPills=$('scalePills');scPills.innerHTML='';
    const ints=gKeyMode==='major'?[0,2,4,5,7,9,11]:[0,2,3,5,7,8,10];
    ints.forEach((iv,i)=>{
      const d=document.createElement('div');
      d.className='scale-pill'+(i===0?' root':'');
      d.textContent=NM[(gKeyRoot+iv)%12];
      scPills.appendChild(d);
    });

    // Chords
    const chEl=$('chordsEl');chEl.innerHTML='';
    getChords(gKeyRoot,gKeyMode).forEach(ch=>{
      const d=document.createElement('div');
      d.className='chord-chip'+(ch.tonic?' tonic':'');
      d.innerHTML=`<span class="chord-roman">${ch.roman}</span><span class="chord-name">${ch.name}</span><span class="chord-type">${ch.type}</span>`;
      chEl.appendChild(d);
    });

    $('xpFrom').textContent=NM[gKeyRoot];
    $('xpTo').textContent=NM[gKeyRoot];
    updateXpDisplay();
    ss('s4','done');ss('s5','active');$('bigFill').style.width='90%';await tick();

    buildDownload(0);
    ss('s5','done');$('bigFill').style.width='100%';await tick();

    $('anaWrap').classList.remove('on');
    $('results').classList.add('on');
    $('results').scrollIntoView({behavior:'smooth',block:'start'});
  }catch(e){
    showErr(e.message);$('anaWrap').classList.remove('on');
  }
  $('procBtn').disabled=false;
}

// Transpose
$('xpDir').addEventListener('change',updateXpDisplay);
$('tgtKey').addEventListener('change',()=>{
  const tgt=parseInt($('tgtKey').value);if(isNaN(tgt))return;
  let s=tgt-gKeyRoot;if(s>6)s-=12;if(s<-6)s+=12;
  const best=Array.from($('xpDir').options).find(o=>parseInt(o.value)===s);
  if(best)$('xpDir').value=String(s);
  updateXpDisplay();
});

function updateXpDisplay(){
  const s=parseInt($('xpDir').value)||0;
  const nr=trR(gKeyRoot,s);
  $('xpTo').textContent=NM[nr];
  $('xpSemi').textContent=s===0?'0 semitones':`${s>0?'+':''}${s} semitone${Math.abs(s)>1?'s':''}`;
  $('tgtKey').value=String(nr);
}

function buildDownload(semi){
  const song=$('songName').value.trim(), art=$('artistName').value.trim();
  const blob=makePDF(gNotes,song,art,gKeyRoot,gKeyMode,semi);
  const url=URL.createObjectURL(blob);
  const base=(song||'bass_tab').replace(/\s+/g,'_');
  const sfx=semi!==0?`_transposed${semi>0?'+':''}${semi}st`:'';
  const name=`${base}${sfx}_bass_tab.pdf`;
  $('dlLink').href=url;$('dlLink').download=name;
  const kr=NM[gKeyRoot], nr=NM[trR(gKeyRoot,semi)];
  const ks=semi!==0?`${kr} ‚Üí ${nr} ${gKeyMode}`:`${kr} ${gKeyMode}`;
  $('dlMeta').textContent=`${gNotes.length} notes ¬∑ A4 ¬∑ Standard tuning (E A D G) ¬∑ Key: ${ks}`;
}

function generateTransposedPDF(){
  if(!gNotes.length)return;
  const s=parseInt($('xpDir').value)||0;
  buildDownload(s);
  $('dlLink').click();
}
</script>
</body>
</html>
